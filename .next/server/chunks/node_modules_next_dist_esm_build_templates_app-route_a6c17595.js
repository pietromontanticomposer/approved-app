module.exports=[22321,e=>{"use strict";var t=e.i(47909),r=e.i(74017),a=e.i(96250),s=e.i(59756),o=e.i(61916),n=e.i(14444),i=e.i(37092),l=e.i(69741),c=e.i(16795),d=e.i(87718),p=e.i(95169),u=e.i(47587),m=e.i(66012),g=e.i(70101),f=e.i(26937),h=e.i(10372),j=e.i(93695);e.i(52474);var R=e.i(5232),E=e.i(89171),w=e.i(44687);async function b(e){try{console.log("[GET /api/projects] Request started"),console.log("[GET /api/projects] Fetching projects from Supabase...");let t=e.headers.get("x-actor-id");if(!t){let r=e.headers.get("authorization")||"";if(r.toLowerCase().startsWith("bearer ")){let e=r.split(" ")[1];try{let{data:r,error:a}=await w.supabaseAdmin.auth.getUser(e);!a&&r?.user?.id?t=r.user.id:console.warn("[GET /api/projects] auth.getUser failed",a?.message||a)}catch(e){console.warn("[GET /api/projects] token verification error",e?.message||e)}}}if(!t)try{let r=e.headers.get("cookie")||"";if(r){let e=["sb-access-token","supabase-auth-token","access_token","token","sb:token"];for(let a of r.split(";").map(e=>e.trim())){let r=a.indexOf("=");if(-1===r)continue;let s=a.substring(0,r).trim(),o=a.substring(r+1).trim();if(e.includes(s)&&o){let e=o;try{e=decodeURIComponent(o)}catch(e){}if(e.startsWith("{"))try{let r=JSON.parse(e);if(r?.access_token){let{data:e,error:a}=await w.supabaseAdmin.auth.getUser(r.access_token);if(!a&&e?.user?.id){t=e.user.id;break}}}catch(e){}else{let r=e.match(/([A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+)/),a=r?r[1]:e;try{let{data:e,error:r}=await w.supabaseAdmin.auth.getUser(a);if(!r&&e?.user?.id){t=e.user.id;break}}catch(e){}}}}}}catch(e){}if(t||console.log("[GET /api/projects] No actor header or valid token provided â€” returning public projects list"),t){let{data:e,error:r}=await w.supabaseAdmin.from("projects").select("*").eq("owner_id",t).order("created_at",{ascending:!1});if(r)return console.error("[GET /api/projects] Error loading my projects:",r),E.NextResponse.json({error:r.message},{status:500});let{data:a,error:s}=await w.supabaseAdmin.from("project_members").select("project_id, role").eq("member_id",t);if(s)return console.error("[GET /api/projects] Error loading project_members:",s),E.NextResponse.json({error:s.message},{status:500});let o=(a||[]).map(e=>e.project_id).filter(Boolean),{data:n,error:i}=await w.supabaseAdmin.from("team_members").select("team_id").eq("user_id",t);if(i)return console.error("[GET /api/projects] Error loading team_members:",i),E.NextResponse.json({error:i.message},{status:500});let l=(n||[]).map(e=>e.team_id).filter(Boolean),c=[];if(l.length){let{data:e,error:t}=await w.supabaseAdmin.from("projects").select("id").in("team_id",l);if(t)return console.error("[GET /api/projects] Error loading projects for teams:",t),E.NextResponse.json({error:t.message},{status:500});c=(e||[]).map(e=>e.id).filter(Boolean)}let d=new Set([...o,...c]),p=new Set((e||[]).map(e=>e.id)),u=Array.from(d).filter(e=>!p.has(e)),m=[];if(u.length){let{data:e,error:t}=await w.supabaseAdmin.from("projects").select("*").in("id",u).order("created_at",{ascending:!1});if(t)return console.error("[GET /api/projects] Error loading shared projects:",t),E.NextResponse.json({error:t.message},{status:500});m=e||[]}let g=async e=>Promise.all((e||[]).map(async e=>{let t=[];try{if(e.team_id){let{data:r}=await w.supabaseAdmin.from("team_members").select("user_id, role, joined_at").eq("team_id",e.team_id);t=r||[]}}catch(t){console.warn("[GET /api/projects] Warning loading team_members for project",e.id,t?.message||t)}return{...e,team_members:t}})),f=await g(e||[]),h=await g(m||[]);return E.NextResponse.json({my_projects:f,shared_with_me:h},{status:200})}let{data:r,error:a}=await w.supabaseAdmin.from("projects").select("*").order("created_at",{ascending:!1});if(a)return console.error("[GET /api/projects] Error loading projects:",a),E.NextResponse.json({error:a.message,code:a.code},{status:500});let s=await Promise.all((r||[]).map(async e=>{let t=[];try{if(e.team_id){let{data:r}=await w.supabaseAdmin.from("team_members").select("user_id, role, joined_at").eq("team_id",e.team_id);t=r||[]}}catch(t){console.warn("[GET /api/projects] Warning loading team_members for project",e.id,t?.message||t)}return{...e,team_members:t}}));return E.NextResponse.json({projects:s},{status:200,headers:{"Content-Type":"application/json"}})}catch(e){return console.error("[GET /api/projects] Exception:",{message:e?.message,stack:e?.stack}),E.NextResponse.json({error:e?.message||"Errore imprevisto",details:String(e)},{status:500})}}async function _(e){try{let t,r=await e.text();if(!r)return console.error("[POST /api/projects] Empty request body"),E.NextResponse.json({error:"Empty request body"},{status:400});try{t=JSON.parse(r)}catch(e){return console.error("[POST /api/projects] JSON parse error",e,"RAW:",r),E.NextResponse.json({error:"Invalid JSON body"},{status:400})}let a="string"==typeof t.name?t.name:"",s="string"==typeof t.description?t.description:"",o="string"==typeof t.team_id?t.team_id:"",n=a.trim(),i=s.trim();if(!n)return E.NextResponse.json({error:"Name is required"},{status:400});let l=e.headers.get("x-actor-id")||null;try{let t=e.headers.get("authorization")||"";if(t.toLowerCase().startsWith("bearer ")){let e=t.split(" ")[1];if(e){let{data:t,error:r}=await w.supabaseAdmin.auth.getUser(e);!r&&t?.user?.id?l=t.user.id:console.warn("[/api/projects] auth.getUser failed",r)}}}catch(e){console.warn("[/api/projects] token verification error",e)}if(!o||"auto"===o){console.log("[POST /api/projects] Auto-creating workspace");let{data:e}=await w.supabaseAdmin.from("teams").select("id").limit(1);if(e&&e.length>0)o=e[0].id,console.log("[POST /api/projects] Using existing team:",o);else{let{data:e,error:t}=await w.supabaseAdmin.from("teams").insert({name:"Personal Workspace",owner_id:l||"system"}).select().single();if(t)return console.error("[POST /api/projects] Error creating team:",t),E.NextResponse.json({error:"Failed to create workspace"},{status:500});o=e.id,console.log("[POST /api/projects] Created new team:",o)}}let c={name:n,description:i||null,team_id:o};l&&(c.owner_id=l);let{data:d,error:p}=await w.supabaseAdmin.from("projects").insert(c).select("id, name, description, created_at, team_id, owner_id").single();if(p)return console.error("[POST /api/projects] Supabase insert error",p),E.NextResponse.json({error:p.message||"Errore nella creazione del progetto su Supabase",details:p},{status:500});try{l&&d?.id&&await w.supabaseAdmin.from("project_members").upsert({project_id:d.id,member_id:l,role:"owner",added_by:l},{onConflict:"(project_id, member_id)"})}catch(e){console.warn("[POST /api/projects] Warning adding project_members for owner",e)}return E.NextResponse.json({project:d},{status:201})}catch(e){return console.error("[POST /api/projects] Unexpected error",e),E.NextResponse.json({error:e?.message||"Errore imprevisto nella creazione del progetto",details:String(e)},{status:500})}}async function y(e){try{let t,r=await e.text();if(!r)return console.error("[PATCH /api/projects] Empty request body"),E.NextResponse.json({error:"Empty request body"},{status:400});try{t=JSON.parse(r)}catch(e){return console.error("[PATCH /api/projects] JSON parse error",e,"RAW:",r),E.NextResponse.json({error:"Invalid JSON body"},{status:400})}let a="string"==typeof t.id?t.id:"",s="string"==typeof t.name?t.name:"",o="string"==typeof t.description?t.description:"",n="string"==typeof t.deleteCueId?t.deleteCueId:"";if(!a)return E.NextResponse.json({error:"id is required"},{status:400});if(n){console.log("[PATCH /api/projects] Deleting cue:",n);let{error:e}=await w.supabaseAdmin.from("cues").delete().eq("id",n).eq("project_id",a);if(e)return console.error("[PATCH /api/projects] Supabase cue delete error",e),E.NextResponse.json({error:e.message||"Errore nella cancellazione della cue",details:e},{status:500});return E.NextResponse.json({success:!0,message:"Cue deleted"},{status:200})}let i={};if(s.trim()&&(i.name=s.trim()),o.trim()&&(i.description=o.trim()),!Object.keys(i).length)return E.NextResponse.json({error:"Nothing to update"},{status:400});let{data:l,error:c}=await w.supabaseAdmin.from("projects").update(i).eq("id",a).select("id, name, description, created_at").single();if(c)return console.error("[PATCH /api/projects] Supabase update error",c),E.NextResponse.json({error:c.message||"Errore nell'aggiornamento del progetto",details:c},{status:500});return E.NextResponse.json({project:l},{status:200})}catch(e){return console.error("[PATCH /api/projects] Unexpected error",e),E.NextResponse.json({error:e?.message||"Errore imprevisto nell'aggiornamento del progetto",details:String(e)},{status:500})}}async function x(e){try{let t=new URL(e.url).searchParams.get("id")??"",r=await e.text(),a=null;if(r)try{a=JSON.parse(r)}catch(e){console.error("[DELETE /api/projects] JSON parse error",e,"RAW:",r)}let s=(a&&"string"==typeof a.id?a.id.trim():"")||t;if(!s)return E.NextResponse.json({error:"id is required"},{status:400});let{error:o}=await w.supabaseAdmin.from("projects").delete().eq("id",s);if(o)return console.error("[DELETE /api/projects] Supabase delete error",o),E.NextResponse.json({error:o.message||"Errore nella cancellazione del progetto",details:o},{status:500});return E.NextResponse.json({success:!0},{status:200})}catch(e){return console.error("[DELETE /api/projects] Unexpected error",e),E.NextResponse.json({error:e?.message||"Errore imprevisto nella cancellazione del progetto",details:String(e)},{status:500})}}e.s(["DELETE",()=>x,"GET",()=>b,"PATCH",()=>y,"POST",()=>_],31326);var N=e.i(31326);let A=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/projects/route",pathname:"/api/projects",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/projects/route.ts",nextConfigOutput:"",userland:N}),{workAsyncStorage:T,workUnitAsyncStorage:v,serverHooks:C}=A;function S(){return(0,a.patchFetch)({workAsyncStorage:T,workUnitAsyncStorage:v})}async function P(e,t,a){A.isDev&&(0,s.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let E="/api/projects/route";E=E.replace(/\/index$/,"")||"/";let w=await A.prepare(e,t,{srcPage:E,multiZoneDraftMode:!1});if(!w)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:b,params:_,nextConfig:y,parsedUrl:x,isDraftMode:N,prerenderManifest:T,routerServerContext:v,isOnDemandRevalidate:C,revalidateOnlyGenerated:S,resolvedPathname:P,clientReferenceManifest:O,serverActionsManifest:k}=w,q=(0,l.normalizeAppPath)(E),U=!!(T.dynamicRoutes[q]||T.routes[P]),H=async()=>((null==v?void 0:v.render404)?await v.render404(e,t,x,!1):t.end("This page could not be found"),null);if(U&&!N){let e=!!T.routes[P],t=T.dynamicRoutes[q];if(t&&!1===t.fallback&&!e){if(y.experimental.adapterPath)return await H();throw new j.NoFallbackError}}let I=null;!U||A.isDev||N||(I="/index"===(I=P)?"/":I);let D=!0===A.isDev||!U,G=U&&!D;k&&O&&(0,n.setReferenceManifestsSingleton)({page:E,clientReferenceManifest:O,serverActionsManifest:k,serverModuleMap:(0,i.createServerModuleMap)({serverActionsManifest:k})});let M=e.method||"GET",L=(0,o.getTracer)(),W=L.getActiveScopeSpan(),z={params:_,prerenderManifest:T,renderOpts:{experimental:{authInterrupts:!!y.experimental.authInterrupts},cacheComponents:!!y.cacheComponents,supportsDynamicResponse:D,incrementalCache:(0,s.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:y.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>A.onRequestError(e,t,a,v)},sharedContext:{buildId:b}},F=new c.NodeNextRequest(e),J=new c.NodeNextResponse(t),$=d.NextRequestAdapter.fromNodeNextRequest(F,(0,d.signalFromNodeResponse)(t));try{let n=async e=>A.handle($,z).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=L.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==p.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${M} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${M} ${E}`)}),i=!!(0,s.getRequestMeta)(e,"minimalMode"),l=async s=>{var o,l;let c=async({previousCacheEntry:r})=>{try{if(!i&&C&&S&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let o=await n(s);e.fetchMetrics=z.renderOpts.fetchMetrics;let l=z.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let c=z.renderOpts.collectedTags;if(!U)return await (0,m.sendResponse)(F,J,o,z.renderOpts.pendingWaitUntil),null;{let e=await o.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(o.headers);c&&(t[h.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==z.renderOpts.collectedRevalidate&&!(z.renderOpts.collectedRevalidate>=h.INFINITE_CACHE)&&z.renderOpts.collectedRevalidate,a=void 0===z.renderOpts.collectedExpire||z.renderOpts.collectedExpire>=h.INFINITE_CACHE?void 0:z.renderOpts.collectedExpire;return{value:{kind:R.CachedRouteKind.APP_ROUTE,status:o.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await A.onRequestError(e,t,{routerKind:"App Router",routePath:E,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:G,isOnDemandRevalidate:C})},v),t}},d=await A.handleResponse({req:e,nextConfig:y,cacheKey:I,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:T,isRoutePPREnabled:!1,isOnDemandRevalidate:C,revalidateOnlyGenerated:S,responseGenerator:c,waitUntil:a.waitUntil,isMinimalMode:i});if(!U)return null;if((null==d||null==(o=d.value)?void 0:o.kind)!==R.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(l=d.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||t.setHeader("x-nextjs-cache",C?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),N&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,g.fromNodeOutgoingHttpHeaders)(d.value.headers);return i&&U||p.delete(h.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,f.getCacheControlHeader)(d.cacheControl)),await (0,m.sendResponse)(F,J,new Response(d.value.body,{headers:p,status:d.value.status||200})),null};W?await l(W):await L.withPropagatedContext(e.headers,()=>L.trace(p.BaseServerSpan.handleRequest,{spanName:`${M} ${E}`,kind:o.SpanKind.SERVER,attributes:{"http.method":M,"http.target":e.url}},l))}catch(t){if(t instanceof j.NoFallbackError||await A.onRequestError(e,t,{routerKind:"App Router",routePath:q,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:G,isOnDemandRevalidate:C})}),U)throw t;return await (0,m.sendResponse)(F,J,new Response(null,{status:500})),null}}e.s(["handler",()=>P,"patchFetch",()=>S,"routeModule",()=>A,"serverHooks",()=>C,"workAsyncStorage",()=>T,"workUnitAsyncStorage",()=>v],22321)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_a6c17595.js.map