module.exports=[9270,(a,b,c)=>{"use strict";b.exports=a.r(42602).vendored.contexts.AppRouterContext},36313,(a,b,c)=>{"use strict";b.exports=a.r(42602).vendored.contexts.HooksClientContext},18341,(a,b,c)=>{"use strict";b.exports=a.r(42602).vendored.contexts.ServerInsertedHtml},56704,(a,b,c)=>{b.exports=a.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(a,b,c)=>{b.exports=a.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},20635,(a,b,c)=>{b.exports=a.x("next/dist/server/app-render/action-async-storage.external.js",()=>require("next/dist/server/app-render/action-async-storage.external.js"))},87924,(a,b,c)=>{"use strict";b.exports=a.r(42602).vendored["react-ssr"].ReactJsxRuntime},46058,(a,b,c)=>{"use strict";function d(a){if("function"!=typeof WeakMap)return null;var b=new WeakMap,c=new WeakMap;return(d=function(a){return a?c:b})(a)}c._=function(a,b){if(!b&&a&&a.__esModule)return a;if(null===a||"object"!=typeof a&&"function"!=typeof a)return{default:a};var c=d(b);if(c&&c.has(a))return c.get(a);var e={__proto__:null},f=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var g in a)if("default"!==g&&Object.prototype.hasOwnProperty.call(a,g)){var h=f?Object.getOwnPropertyDescriptor(a,g):null;h&&(h.get||h.set)?Object.defineProperty(e,g,h):e[g]=a[g]}return e.default=a,c&&c.set(a,e),e}},95769,a=>{"use strict";var b=a.i(87924),c=a.i(72131),d=a.i(50944);function e(){let e=(0,d.useRouter)(),f=(0,d.useParams)().token,[g,h]=(0,c.useState)(null),[i,j]=(0,c.useState)(null),[k,l]=(0,c.useState)(null),[m,n]=(0,c.useState)(!0),[o,p]=(0,c.useState)(""),[q,r]=(0,c.useState)(!1),[s,t]=(0,c.useState)(""),[u,v]=(0,c.useState)(!1);(0,c.useEffect)(()=>{w()},[f]),(0,c.useEffect)(()=>{a.A(61780).then(a=>{let b=a.getSupabaseClient();h(b),(async()=>{try{let{data:a}=await b.auth.getUser();a&&a.user&&j(a.user)}catch(a){console.warn("[Share] supabase getUser failed",a)}})();let{data:c}=b.auth.onAuthStateChange((a,c)=>{c&&c.access_token?b.auth.getUser().then(a=>{a?.data?.user&&j(a.data.user)}).catch(()=>{}):j(null)});return()=>{try{c?.subscription?.unsubscribe?.()}catch(a){}}}).catch(a=>console.warn("[Share] failed to init supabase",a))},[]);let w=async()=>{try{let a=new URLSearchParams(window.location.search).get("token");try{let b="https://approved-app-pietros-projects-7763063d.vercel.app".trim();if(b){let c=window.location.origin.replace(/\/+$/,""),d=b.replace(/\/+$/,"");if(d&&c!==d){let b=`/share/${encodeURIComponent(f||"")}`+(a?`?token=${encodeURIComponent(a)}`:""),c=`${d}${b}`;window.location.replace(c);return}}}catch(a){console.warn("[Share] redirect check failed",a)}if(!f||!a){p("Link non valido"),n(!1);return}let b=await fetch(`/api/share/details?share_id=${encodeURIComponent(f)}&token=${encodeURIComponent(a)}`);if(!b.ok){let a=await b.json().catch(()=>({}));console.error("[Share] details API failed",b.status,a),p(a?.error||"Link non trovato o non valido."),n(!1);return}let c=await b.json();l(c),n(!1)}catch(a){console.error("[Share] initialize error",a),p("Errore durante il caricamento del link."),n(!1)}},x=async()=>{let a=new URLSearchParams(window.location.search).get("token")||"";if(!i){try{localStorage.setItem("pending_share",JSON.stringify({share_id:f,token:a}))}catch(a){console.warn("[Share] could not set pending_share",a)}return s&&g?void await y(s):void e.push("/register")}try{let b=await fetch("/api/share/redeem",{method:"POST",headers:{"Content-Type":"application/json","x-actor-id":i.id},body:JSON.stringify({share_id:f,token:a})});if(!b.ok){let a=await b.json().catch(()=>({}));p(a?.error||"Impossibile aprire il progetto");return}let c=await b.json();if(r(!0),c&&c.project_id)try{localStorage.setItem("open_project",c.project_id)}catch(a){console.warn("[Share] Could not set open_project in localStorage",a)}setTimeout(()=>e.push("/"),400)}catch(a){console.error("[Share] redeem error",a),p("Errore durante l'apertura del progetto")}},y=async a=>{if(!g)return void p("Impossibile inizializzare l'autenticazione");v(!0);try{let b=window.location.href.split("#")[0],c=await g.auth.signInWithOtp({email:a,options:{emailRedirectTo:b}});c.error?p(c.error.message||"Errore durante l'invio del link"):r(!0)}catch(a){console.error("[Share] sendMagicLink error",a),p(a?.message||"Errore durante l'invio del link")}finally{v(!1)}};return((0,c.useEffect)(()=>{if(i&&!m&&k&&!q){let a=setTimeout(()=>{x()},200);return()=>clearTimeout(a)}},[i,m,k,q]),m)?(0,b.jsx)("div",{style:{padding:40},children:"Caricamento link…"}):o?(0,b.jsxs)("div",{style:{padding:40},children:[(0,b.jsx)("h2",{children:"Link non valido"}),(0,b.jsx)("p",{children:o}),(0,b.jsx)("button",{onClick:()=>e.push("/"),children:"Torna alla home"})]}):q?(0,b.jsx)("div",{style:{padding:40},children:(0,b.jsx)("h2",{children:"Aprendo il progetto…"})}):(0,b.jsxs)("div",{style:{padding:24,maxWidth:680,margin:"40px auto"},children:[(0,b.jsx)("h2",{children:"Progetto condiviso"}),(0,b.jsxs)("p",{style:{color:"#999"},children:["Progetto: ",(0,b.jsx)("strong",{children:k.project_name})]}),(0,b.jsxs)("p",{style:{color:"#999"},children:["Ruolo consentito: ",(0,b.jsx)("strong",{children:k.role})]}),(0,b.jsx)("div",{style:{marginTop:20},children:i?(0,b.jsx)("button",{onClick:x,style:{padding:"10px 14px"},children:"Apri progetto"}):(0,b.jsxs)("div",{style:{display:"flex",gap:8,flexDirection:"column",maxWidth:420},children:[(0,b.jsx)("p",{style:{color:"#555"},children:"Per aprire il progetto devi avere un account. Puoi crearne uno rapidamente inserendo la tua email qui sotto; ti invieremo un link magico per accedere e completare l'apertura."}),(0,b.jsx)("input",{type:"email",value:s,onChange:a=>t(a.target.value),placeholder:"La tua email",style:{padding:"8px 10px",fontSize:16}}),(0,b.jsxs)("div",{style:{display:"flex",gap:8},children:[(0,b.jsx)("button",{onClick:()=>y(s),disabled:u||!s,style:{padding:"10px 14px"},children:u?"Invio…":"Ricevi link magico"}),(0,b.jsx)("button",{onClick:()=>{localStorage.setItem("pending_share",JSON.stringify({share_id:f,token:new URLSearchParams(window.location.search).get("token")||""})),e.push("/login")},style:{padding:"10px 14px"},children:"Ho già un account (Accedi)"})]})]})})]})}a.s(["default",()=>e])},61780,a=>{a.v(a=>Promise.resolve().then(()=>a(7291)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__6f0158c7._.js.map