{"version":3,"sources":["../../../../node_modules/next/src/server/route-modules/app-page/vendored/contexts/app-router-context.ts","../../../../node_modules/next/src/server/route-modules/app-page/vendored/contexts/hooks-client-context.ts","../../../../node_modules/next/src/server/route-modules/app-page/vendored/contexts/server-inserted-html.ts","../../../../node_modules/next/src/server/route-modules/app-page/module.compiled.js","../../../../node_modules/next/src/server/route-modules/app-page/vendored/ssr/react-jsx-runtime.ts","../../../../node_modules/next/src/server/route-modules/app-page/vendored/ssr/react.ts","../../../../node_modules/%40swc/helpers/cjs/_interop_require_wildcard.cjs","../../../../app/share/%5Btoken%5D/page.tsx"],"sourcesContent":["module.exports = (\n  require('../../module.compiled') as typeof import('../../module.compiled')\n).vendored['contexts'].AppRouterContext\n","module.exports = (\n  require('../../module.compiled') as typeof import('../../module.compiled')\n).vendored['contexts'].HooksClientContext\n","module.exports = (\n  require('../../module.compiled') as typeof import('../../module.compiled')\n).vendored['contexts'].ServerInsertedHtml\n","if (process.env.NEXT_RUNTIME === 'edge') {\n  module.exports = require('next/dist/server/route-modules/app-page/module.js')\n} else {\n  if (process.env.__NEXT_EXPERIMENTAL_REACT) {\n    if (process.env.NODE_ENV === 'development') {\n      if (process.env.TURBOPACK) {\n        module.exports = require('next/dist/compiled/next-server/app-page-turbo-experimental.runtime.dev.js')\n      } else {\n        module.exports = require('next/dist/compiled/next-server/app-page-experimental.runtime.dev.js')\n      }\n    } else {\n      if (process.env.TURBOPACK) {\n        module.exports = require('next/dist/compiled/next-server/app-page-turbo-experimental.runtime.prod.js')\n      } else {\n        module.exports = require('next/dist/compiled/next-server/app-page-experimental.runtime.prod.js')\n      }\n    }\n  } else {\n    if (process.env.NODE_ENV === 'development') {\n      if (process.env.TURBOPACK) {\n        module.exports = require('next/dist/compiled/next-server/app-page-turbo.runtime.dev.js')\n      } else {\n        module.exports = require('next/dist/compiled/next-server/app-page.runtime.dev.js')\n      }\n    } else {\n      if (process.env.TURBOPACK) {\n        module.exports = require('next/dist/compiled/next-server/app-page-turbo.runtime.prod.js')\n      } else {\n        module.exports = require('next/dist/compiled/next-server/app-page.runtime.prod.js')\n      }\n    }\n  }\n}\n","module.exports = (\n  require('../../module.compiled') as typeof import('../../module.compiled')\n).vendored['react-ssr']!.ReactJsxRuntime\n","module.exports = (\n  require('../../module.compiled') as typeof import('../../module.compiled')\n).vendored['react-ssr']!.React\n","\"use strict\";\n\nfunction _getRequireWildcardCache(nodeInterop) {\n    if (typeof WeakMap !== \"function\") return null;\n\n    var cacheBabelInterop = new WeakMap();\n    var cacheNodeInterop = new WeakMap();\n\n    return (_getRequireWildcardCache = function(nodeInterop) {\n        return nodeInterop ? cacheNodeInterop : cacheBabelInterop;\n    })(nodeInterop);\n}\nfunction _interop_require_wildcard(obj, nodeInterop) {\n    if (!nodeInterop && obj && obj.__esModule) return obj;\n    if (obj === null || typeof obj !== \"object\" && typeof obj !== \"function\") return { default: obj };\n\n    var cache = _getRequireWildcardCache(nodeInterop);\n\n    if (cache && cache.has(obj)) return cache.get(obj);\n\n    var newObj = { __proto__: null };\n    var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor;\n\n    for (var key in obj) {\n        if (key !== \"default\" && Object.prototype.hasOwnProperty.call(obj, key)) {\n            var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null;\n            if (desc && (desc.get || desc.set)) Object.defineProperty(newObj, key, desc);\n            else newObj[key] = obj[key];\n        }\n    }\n\n    newObj.default = obj;\n\n    if (cache) cache.set(obj, newObj);\n\n    return newObj;\n}\nexports._ = _interop_require_wildcard;\n","\"use client\";\n\nimport { useEffect, useState } from \"react\";\nimport { useRouter, useParams } from \"next/navigation\";\n\nexport default function SharePage() {\n  const router = useRouter();\n  const params = useParams();\n  const token = params.token as string;\n\n  const [supabase, setSupabase] = useState<any>(null);\n  const [user, setUser] = useState<any>(null);\n  const [share, setShare] = useState<any>(null);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState(\"\");\n  const [success, setSuccess] = useState(false);\n\n  useEffect(() => {\n    initializeShare();\n  }, [token]);\n\n  useEffect(() => {\n    // Initialize Supabase client on the browser and get current user\n    import('@/lib/supabaseClient').then(mod => {\n      const client = mod.getSupabaseClient();\n      setSupabase(client);\n\n      // Try to read current user/session\n      (async () => {\n        try {\n          const { data } = await client.auth.getUser();\n          if (data && (data as any).user) setUser((data as any).user);\n        } catch (e) {\n          console.warn('[Share] supabase getUser failed', e);\n        }\n      })();\n\n      // Listen for auth changes\n      const { data: sub } = client.auth.onAuthStateChange((event: any, session: any) => {\n        if (session && session.access_token) {\n          client.auth.getUser().then(res => {\n            if (res?.data?.user) setUser(res.data.user);\n          }).catch(() => {});\n        } else {\n          setUser(null);\n        }\n      });\n\n      // cleanup\n      return () => {\n        try { sub?.subscription?.unsubscribe?.(); } catch (e) {}\n      };\n    }).catch(err => console.warn('[Share] failed to init supabase', err));\n  }, []);\n\n  const initializeShare = async () => {\n    try {\n      // We expect links in the form /share/{shareId}?token={token}\n      const shareId = token;\n      const params = new URLSearchParams(window.location.search);\n      const tokenQuery = params.get('token');\n\n      // If a public app URL is configured, and current origin doesn't match it,\n      // redirect there so links generated on localhost still work from other machines.\n      try {\n        const appUrl = (process.env.NEXT_PUBLIC_APP_URL || process.env.NEXT_PUBLIC_APP_ORIGIN || '').trim();\n        if (appUrl) {\n          const currentOrigin = window.location.origin.replace(/\\/+$/, '');\n          const normalizedApp = appUrl.replace(/\\/+$/, '');\n          if (normalizedApp && currentOrigin !== normalizedApp) {\n            const redirectPath = `/share/${encodeURIComponent(shareId || '')}` + (tokenQuery ? `?token=${encodeURIComponent(tokenQuery)}` : '');\n            const target = `${normalizedApp}${redirectPath}`;\n            window.location.replace(target);\n            return;\n          }\n        }\n      } catch (e) {\n        console.warn('[Share] redirect check failed', e);\n      }\n\n      if (!shareId || !tokenQuery) {\n        setError('Link non valido');\n        setLoading(false);\n        return;\n      }\n\n      // Fetch details from server-side helper which validates token hash\n      const resp = await fetch(`/api/share/details?share_id=${encodeURIComponent(shareId)}&token=${encodeURIComponent(tokenQuery)}`);\n      if (!resp.ok) {\n        const body = await resp.json().catch(() => ({}));\n        console.error('[Share] details API failed', resp.status, body);\n        setError(body?.error || 'Link non trovato o non valido.');\n        setLoading(false);\n        return;\n      }\n\n      const body = await resp.json();\n      setShare(body);\n      setLoading(false);\n    } catch (err) {\n      console.error('[Share] initialize error', err);\n      setError('Errore durante il caricamento del link.');\n      setLoading(false);\n    }\n  };\n\n  const handleOpen = async () => {\n    const shareId = token;\n    const params = new URLSearchParams(window.location.search);\n    const tokenQuery = params.get('token') || '';\n\n    if (!user) {\n      localStorage.setItem('pending_share', JSON.stringify({ share_id: shareId, token: tokenQuery }));\n      router.push('/login');\n      return;\n    }\n\n    // Redeem via server API\n    try {\n      const resp = await fetch('/api/share/redeem', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'x-actor-id': user.id\n        },\n        body: JSON.stringify({ share_id: shareId, token: tokenQuery })\n      });\n\n      if (!resp.ok) {\n        const b = await resp.json().catch(() => ({}));\n        setError(b?.error || 'Impossibile aprire il progetto');\n        return;\n      }\n\n      const b = await resp.json();\n      setSuccess(true);\n      // Ask the main app to open the redeemed project when landing on the home page\n      if (b && b.project_id) {\n        try {\n          localStorage.setItem('open_project', b.project_id);\n        } catch (e) {\n          console.warn('[Share] Could not set open_project in localStorage', e);\n        }\n      }\n      setTimeout(() => router.push('/'), 400);\n    } catch (err) {\n      console.error('[Share] redeem error', err);\n      setError('Errore durante l\\'apertura del progetto');\n    }\n  };\n\n  // Auto-redeem when user is already logged in and share details loaded\n  useEffect(() => {\n    if (user && !loading && share && !success) {\n      // small delay to allow UI to settle\n      const t = setTimeout(() => {\n        handleOpen();\n      }, 200);\n      return () => clearTimeout(t);\n    }\n  }, [user, loading, share, success]);\n\n  if (loading) {\n    return <div style={{ padding: 40 }}>Caricamento link…</div>;\n  }\n\n  if (error) {\n    return (\n      <div style={{ padding: 40 }}>\n        <h2>Link non valido</h2>\n        <p>{error}</p>\n        <button onClick={() => router.push('/')}>Torna alla home</button>\n      </div>\n    );\n  }\n\n  if (success) {\n    return (\n      <div style={{ padding: 40 }}>\n        <h2>Aprendo il progetto…</h2>\n      </div>\n    );\n  }\n\n  return (\n    <div style={{ padding: 24, maxWidth: 680, margin: '40px auto' }}>\n      <h2>Progetto condiviso</h2>\n      <p style={{ color: '#999' }}>Progetto: <strong>{share.project_name}</strong></p>\n      <p style={{ color: '#999' }}>Ruolo consentito: <strong>{share.role}</strong></p>\n      <div style={{ marginTop: 20 }}>\n        <button onClick={handleOpen} style={{ padding: '10px 14px' }}>\n          {user ? 'Apri progetto' : 'Accedi per aprire'}\n        </button>\n      </div>\n    </div>\n  );\n}\n"],"names":["module","exports","require","vendored","AppRouterContext","HooksClientContext","ServerInsertedHtml","process","env","NEXT_RUNTIME","__NEXT_EXPERIMENTAL_REACT","NODE_ENV","TURBOPACK","ReactJsxRuntime","React"],"mappings":"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","ignoreList":[0,1,2,3,4,5,6]}