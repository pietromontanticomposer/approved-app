{"version":3,"sources":["../../../lib/actorResolver.ts"],"sourcesContent":["import { supabaseAdmin } from './supabaseAdmin';\n\n// Resolve a possible actor identifier (could be UID or email) to a Supabase UID.\nexport async function resolveActorId(candidate: string | null): Promise<string | null> {\n  if (!candidate) return null;\n\n  // If the candidate is an Authorization header value like \"Bearer <token>\",\n  // try to resolve the token to a user via the admin client.\n  const maybeBearer = String(candidate || '').trim();\n  if (/^Bearer\\s+/i.test(maybeBearer)) {\n    const token = maybeBearer.split(/\\s+/)[1];\n    if (token) {\n      try {\n        const { data, error } = await supabaseAdmin.auth.getUser(token as string);\n        if (!error && data?.user?.id) return data.user.id;\n      } catch (e) {\n        // ignore\n      }\n    }\n  }\n\n  // If it already looks like a UUID, assume it's a UID\n  const uuidRegex = /^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-5][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}$/;\n  if (uuidRegex.test(candidate)) return candidate;\n\n  // If it looks like an email, try to find the user by email using admin API\n  if (candidate.includes('@')) {\n    try {\n      // Prefer admin.listUsers if available\n      if (supabaseAdmin.auth && supabaseAdmin.auth.admin && typeof supabaseAdmin.auth.admin.listUsers === 'function') {\n        const res = await supabaseAdmin.auth.admin.listUsers({ search: candidate });\n        if (!res.error && res.data && Array.isArray(res.data.users)) {\n          const exact = res.data.users.find((u: any) => (u.email || '').toLowerCase() === candidate.toLowerCase());\n          if (exact) return exact.id;\n        }\n      }\n\n      // Fallback: query auth.users directly\n      try {\n        const { data } = await supabaseAdmin.from('auth.users').select('id,email').eq('email', candidate).limit(1).maybeSingle();\n        if (data && data.id) return data.id;\n      } catch (e) {\n        // ignore\n      }\n    } catch (e) {\n      // ignore lookup errors\n    }\n  }\n\n  return null;\n}\n\n"],"names":[],"mappings":"uCAAA,IAAA,EAAA,EAAA,CAAA,CAAA,OAGO,eAAe,EAAe,CAAwB,EAC3D,GAAI,CAAC,EAAW,OAAO,KAIvB,IAAM,EAAc,OAAO,GAAa,IAAI,IAAI,GAChD,GAAI,cAAc,IAAI,CAAC,GAAc,CACnC,IAAM,EAAQ,EAAY,KAAK,CAAC,MAAM,CAAC,EAAE,CACzC,GAAI,EACF,GAAI,CACF,CAFO,EAED,MAAE,CAAI,OAAE,CAAK,CAAE,CAAG,MAAM,EAAA,aAAa,CAAC,IAAI,CAAC,OAAO,CAAC,GACzD,GAAI,CAAC,GAAS,GAAM,MAAM,GAAI,OAAO,EAAK,IAAI,CAAC,EAAE,AACnD,CAAE,MAAO,EAAG,CAEZ,CAEJ,CAIA,GADkB,AACd,6FAAU,IAAI,CAAC,GAAY,OAAO,EAGtC,GAAI,EAAU,QAAQ,CAAC,KACrB,CAD2B,EACvB,CAEF,GAAI,EAAA,aAAa,CAAC,IAAI,EAAI,EAAA,aAAa,CAAC,IAAI,CAAC,KAAK,EAAkD,YAA9C,OAAO,EAAA,aAAa,CAAC,IAAI,CAAC,KAAK,CAAC,SAAS,CAAiB,CAC9G,IAAM,EAAM,MAAM,EAAA,aAAa,CAAC,IAAI,CAAC,KAAK,CAAC,SAAS,CAAC,CAAE,OAAQ,CAAU,GACzE,GAAI,CAAC,EAAI,KAAK,EAAI,EAAI,IAAI,EAAI,MAAM,OAAO,CAAC,EAAI,IAAI,CAAC,KAAK,EAAG,CAC3D,IAAM,EAAQ,EAAI,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,AAAC,GAAW,CAAC,EAAE,KAAK,EAAI,EAAA,CAAE,CAAE,WAAW,KAAO,EAAU,WAAW,IACrG,GAAI,EAAO,OAAO,EAAM,EAAE,AAC5B,CACF,CAGA,GAAI,CACF,GAAM,MAAE,CAAI,CAAE,CAAG,MAAM,EAAA,aAAa,CAAC,IAAI,CAAC,cAAc,MAAM,CAAC,YAAY,EAAE,CAAC,QAAS,GAAW,KAAK,CAAC,GAAG,WAAW,GACtH,GAAI,GAAQ,EAAK,EAAE,CAAE,OAAO,EAAK,EAAE,AACrC,CAAE,MAAO,EAAG,CAEZ,CACF,CAAE,MAAO,EAAG,CAEZ,CAGF,OAAO,IACT"}