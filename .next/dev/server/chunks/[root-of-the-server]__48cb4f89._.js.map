{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/pietromontanti/Desktop/approved-clean/Approved/lib/supabaseAdmin.ts"],"sourcesContent":["import { createClient } from \"@supabase/supabase-js\";\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\nconst supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\n\nif (!supabaseUrl || !supabaseServiceKey) {\n  throw new Error(\n    \"Missing NEXT_PUBLIC_SUPABASE_URL or SUPABASE_SERVICE_ROLE_KEY in environment.\"\n  );\n}\n\n// Admin client â€” use only on the server\nexport const supabaseAdmin = createClient(supabaseUrl, supabaseServiceKey, {\n  auth: { persistSession: false },\n});\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM;AACN,MAAM,qBAAqB,QAAQ,GAAG,CAAC,yBAAyB;AAEhE,IAAI,CAAC,eAAe,CAAC,oBAAoB;IACvC,MAAM,IAAI,MACR;AAEJ;AAGO,MAAM,gBAAgB,IAAA,yLAAY,EAAC,aAAa,oBAAoB;IACzE,MAAM;QAAE,gBAAgB;IAAM;AAChC"}},
    {"offset": {"line": 66, "column": 0}, "map": {"version":3,"sources":["file:///Users/pietromontanti/Desktop/approved-clean/Approved/app/api/media/stream/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\nimport { supabaseAdmin } from \"@/lib/supabaseAdmin\";\n\nexport const runtime = \"nodejs\";\n\nconst STORAGE_BUCKET = process.env.NEXT_PUBLIC_SUPABASE_STORAGE_BUCKET || \"media\";\nconst SIGNED_URL_TTL_SECONDS = parseInt(process.env.NEXT_PUBLIC_SUPABASE_SIGNED_TTL || \"7200\", 10);\n\nfunction normalizeStoragePath(path: string | null) {\n  if (!path) return null;\n  const trimmed = path.replace(/^\\/+/, \"\");\n  // If path includes bucket prefix like \"media/...\", remove the bucket name\n  if (trimmed.startsWith(`${STORAGE_BUCKET}/`)) {\n    return trimmed.slice(STORAGE_BUCKET.length + 1);\n  }\n  return trimmed;\n}\n\nexport async function GET(req: Request) {\n  try {\n    const url = new URL(req.url);\n    const rawPath = url.searchParams.get(\"path\");\n    const rawUrl = url.searchParams.get(\"url\");\n\n    let targetUrl: string | null = null;\n\n    if (rawUrl) {\n      // If caller passes an absolute URL (signed or public), use it directly\n      targetUrl = rawUrl;\n    } else if (rawPath) {\n      const clean = normalizeStoragePath(rawPath);\n      if (!clean) return NextResponse.json({ error: \"invalid path\" }, { status: 400 });\n      // create signed URL server-side\n      const { data, error } = await supabaseAdmin.storage\n        .from(STORAGE_BUCKET)\n        .createSignedUrl(clean, SIGNED_URL_TTL_SECONDS);\n      if (error) {\n        console.warn(\"[GET /api/media/stream] createSignedUrl error\", error);\n        // fallback to public url\n        const { data: pub } = supabaseAdmin.storage.from(STORAGE_BUCKET).getPublicUrl(clean);\n        targetUrl = pub?.publicUrl || null;\n      } else {\n        targetUrl = data?.signedUrl || null;\n      }\n    } else {\n      return NextResponse.json({ error: \"path or url required\" }, { status: 400 });\n    }\n\n    if (!targetUrl) return NextResponse.json({ error: \"no target url\" }, { status: 404 });\n\n    // Fetch the media server-side and stream it back with permissive CORS so the browser\n    // can use it from our domain (avoids bucket CORS issues when using signed URLs).\n    // Forward Range and related headers so the browser can request partial content\n    const forwardedHeaders: Record<string, string> = {};\n    const range = req.headers.get('range');\n    const ifRange = req.headers.get('if-range');\n    const accept = req.headers.get('accept');\n    if (range) forwardedHeaders['range'] = range;\n    if (ifRange) forwardedHeaders['if-range'] = ifRange;\n    if (accept) forwardedHeaders['accept'] = accept;\n\n    let res;\n    try {\n      res = await fetch(targetUrl, { headers: forwardedHeaders });\n    } catch (fetchErr: any) {\n      console.error(\"[GET /api/media/stream] fetch exception\", { targetUrl, fetchErr });\n      return NextResponse.json({ error: \"exception fetching upstream media\", details: String(fetchErr) }, { status: 502 });\n    }\n\n    // If upstream returned non-OK (including 4xx/5xx), propagate status and small body snippet\n    if (!res.ok) {\n      let txt = null;\n      try {\n        txt = await res.text();\n      } catch (e) {\n        txt = `<unable to read body: ${String(e)}>`;\n      }\n      console.error(\"[GET /api/media/stream] upstream fetch failed\", { status: res.status, statusText: res.statusText, bodySnippet: txt && txt.slice ? txt.slice(0, 200) : txt, targetUrl });\n      const errHeaders = new Headers();\n      errHeaders.set('Content-Type', 'application/json');\n      errHeaders.set('Access-Control-Allow-Origin', '*');\n      return new NextResponse(JSON.stringify({ error: 'upstream fetch failed', upstreamStatus: res.status, upstreamText: txt && txt.slice ? txt.slice(0,200) : txt }), { status: res.status, headers: errHeaders });\n    }\n\n    // Copy relevant headers from upstream and add CORS\n    const headers = new Headers();\n    const contentType = res.headers.get('content-type');\n    if (contentType) headers.set('Content-Type', contentType);\n    const contentLength = res.headers.get('content-length');\n    if (contentLength) headers.set('Content-Length', contentLength);\n    const acceptRanges = res.headers.get('accept-ranges');\n    if (acceptRanges) headers.set('Accept-Ranges', acceptRanges);\n    const contentRange = res.headers.get('content-range');\n    if (contentRange) headers.set('Content-Range', contentRange);\n    // Cache control: prefer upstream value if present\n    const upstreamCache = res.headers.get('cache-control');\n    headers.set('Cache-Control', upstreamCache || 'public, max-age=3600');\n    headers.set('Access-Control-Allow-Origin', '*');\n\n    return new NextResponse(res.body, { status: res.status, headers });\n  } catch (err: any) {\n    console.error(\"[GET /api/media/stream] Exception\", err);\n    return NextResponse.json({ error: String(err) }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":"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"}}]
}