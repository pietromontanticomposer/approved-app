{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/pietromontanti/Desktop/approved-clean/Approved/lib/supabaseAdmin.ts"],"sourcesContent":["import { createClient } from \"@supabase/supabase-js\";\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\nconst supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\n\nif (!supabaseUrl || !supabaseServiceKey) {\n  throw new Error(\n    \"Missing NEXT_PUBLIC_SUPABASE_URL or SUPABASE_SERVICE_ROLE_KEY in environment.\"\n  );\n}\n\n// Admin client â€” use only on the server\nexport const supabaseAdmin = createClient(supabaseUrl, supabaseServiceKey, {\n  auth: { persistSession: false },\n});\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM;AACN,MAAM,qBAAqB,QAAQ,GAAG,CAAC,yBAAyB;AAEhE,IAAI,CAAC,eAAe,CAAC,oBAAoB;IACvC,MAAM,IAAI,MACR;AAEJ;AAGO,MAAM,gBAAgB,IAAA,yLAAY,EAAC,aAAa,oBAAoB;IACzE,MAAM;QAAE,gBAAgB;IAAM;AAChC"}},
    {"offset": {"line": 72, "column": 0}, "map": {"version":3,"sources":["file:///Users/pietromontanti/Desktop/approved-clean/Approved/app/api/projects/share/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\nimport { supabaseAdmin } from \"@/lib/supabaseAdmin\";\nimport crypto from \"crypto\";\n\n/**\n * POST /api/projects/share\n * Body: { project_id, role?: 'view'|'contribute'|'manage', expires_at?: string, max_uses?: number }\n * Header: x-actor-id (user id performing the action)\n * Returns: { id, link }\n */\nexport async function POST(req: Request) {\n  try {\n    const raw = await req.text();\n    if (!raw) return NextResponse.json({ error: 'Empty body' }, { status: 400 });\n    const body = JSON.parse(raw);\n    const projectId = typeof body.project_id === 'string' ? body.project_id : '';\n    const role = typeof body.role === 'string' ? body.role : 'view';\n    const expiresAt = typeof body.expires_at === 'string' ? body.expires_at : null;\n    const maxUses = typeof body.max_uses === 'number' ? body.max_uses : null;\n\n    // Prefer server-verified actor via Authorization: Bearer <token>\n    let actorId = req.headers.get('x-actor-id');\n    try {\n      const authHeader = req.headers.get('authorization') || '';\n      if (authHeader.toLowerCase().startsWith('bearer ')) {\n        const token = authHeader.split(' ')[1];\n        if (token) {\n          const { data: verified, error: verifyErr } = await supabaseAdmin.auth.getUser(token);\n          if (!verifyErr && verified?.user?.id) {\n            actorId = verified.user.id;\n          } else {\n            console.warn('[/api/projects/share] auth.getUser failed', verifyErr);\n          }\n        }\n      }\n    } catch (e) {\n      console.warn('[/api/projects/share] token verification error', e);\n    }\n\n    if (!actorId) return NextResponse.json({ error: 'Missing x-actor-id header or Authorization token' }, { status: 403 });\n    if (!projectId) return NextResponse.json({ error: 'project_id is required' }, { status: 400 });\n\n    // Verify actor is owner or manager of the project\n    const { data: proj, error: projErr } = await supabaseAdmin\n      .from('projects')\n      .select('id, team_id, owner_id')\n      .eq('id', projectId)\n      .maybeSingle();\n    if (projErr || !proj) return NextResponse.json({ error: 'Project not found' }, { status: 404 });\n\n    // Simple ownership check: match owner or check project_members\n    let isAuthorized = false;\n    if (proj.owner_id && proj.owner_id === actorId) isAuthorized = true;\n\n    if (!isAuthorized) {\n      const { data: pm } = await supabaseAdmin\n        .from('project_members')\n        .select('role')\n        .eq('project_id', projectId)\n        .eq('member_id', actorId)\n        .limit(1);\n      if (pm && pm.length > 0 && (pm[0].role === 'owner' || pm[0].role === 'manage')) isAuthorized = true;\n    }\n\n    // If still not authorized and project has no owner_id set, check the team's owner via team_members\n    if (!isAuthorized && !proj.owner_id && proj.team_id) {\n      try {\n        const { data: teamOwnerRows } = await supabaseAdmin\n          .from('team_members')\n          .select('user_id, role')\n          .eq('team_id', proj.team_id)\n          .eq('role', 'owner')\n          .limit(1);\n        const ownerRow = Array.isArray(teamOwnerRows) ? teamOwnerRows[0] : teamOwnerRows;\n        if (ownerRow && ownerRow.user_id === actorId) isAuthorized = true;\n      } catch (e) {\n        console.warn('[/api/projects/share] team owner lookup failed', e);\n      }\n    }\n\n    if (!isAuthorized) {\n      console.warn('[/api/projects/share] Forbidden: actor not authorized', { actorId, projectOwner: proj.owner_id });\n      const { data: pmDebug } = await supabaseAdmin.from('project_members').select('member_id,role').eq('project_id', projectId);\n      console.warn('[/api/projects/share] project_members for project', projectId, pmDebug || []);\n      return NextResponse.json({ error: 'Forbidden' }, { status: 403 });\n    }\n\n    // Generate token and store only hash\n    const token = crypto.randomBytes(32).toString('base64url');\n    const tokenHash = crypto.createHash('sha256').update(token).digest('hex');\n\n    const insert = {\n      project_id: projectId,\n      role,\n      token_hash: tokenHash,\n      created_by: actorId,\n      expires_at: expiresAt,\n      max_uses: maxUses,\n    };\n\n    const { data, error } = await supabaseAdmin.from('share_links').insert(insert).select().single();\n    if (error) return NextResponse.json({ error: error.message }, { status: 500 });\n\n    // Build safe origin: prefer NEXT_PUBLIC_APP_URL, then Origin header, then x-forwarded-proto + host, then localhost fallback\n    const envUrl = process.env.NEXT_PUBLIC_APP_URL || process.env.NEXT_PUBLIC_APP_ORIGIN || '';\n    const originHeader = req.headers.get('origin');\n    const forwardedProto = req.headers.get('x-forwarded-proto');\n    const hostHeader = req.headers.get('host');\n    const fallbackProto = forwardedProto || 'http';\n    const computedOrigin = envUrl || originHeader || (hostHeader ? `${fallbackProto}://${hostHeader}` : `http://localhost:3000`);\n    const safeOrigin = computedOrigin.replace(/\\/+$/, '');\n\n    const cleanToken = String(token || '').trim();\n    const link = `${safeOrigin}/share/${data.id}?token=${encodeURIComponent(cleanToken)}`;\n\n    // Log audit\n    await supabaseAdmin.from('audit_logs').insert({ actor_id: actorId, action: 'share_link_created', target_type: 'project', target_id: projectId, meta: { share_link_id: data.id, role } });\n\n    return NextResponse.json({ id: data.id, link }, { status: 201 });\n  } catch (err: any) {\n    console.error('[POST /api/projects/share] Error', err);\n    return NextResponse.json({ error: err?.message || 'Unexpected error' }, { status: 500 });\n  }\n}\n\n/**\n * DELETE /api/projects/share\n * Body: { id }\n * Header: x-actor-id\n */\nexport async function DELETE(req: Request) {\n  try {\n    const raw = await req.text();\n    if (!raw) return NextResponse.json({ error: 'Empty body' }, { status: 400 });\n    const body = JSON.parse(raw);\n    const id = typeof body.id === 'string' ? body.id : '';\n    const actorId = req.headers.get('x-actor-id');\n    if (!actorId) return NextResponse.json({ error: 'Missing x-actor-id header' }, { status: 403 });\n    if (!id) return NextResponse.json({ error: 'id is required' }, { status: 400 });\n\n    // Load share link to get project\n    const { data: linkData, error: linkErr } = await supabaseAdmin.from('share_links').select('id, project_id, created_by').eq('id', id).maybeSingle();\n    if (linkErr || !linkData) return NextResponse.json({ error: 'Share link not found' }, { status: 404 });\n\n    // Check actor authorization (owner/manage)\n    const { data: proj } = await supabaseAdmin.from('projects').select('owner_id').eq('id', linkData.project_id).maybeSingle();\n    let isAuthorized = false;\n    if (proj?.owner_id === actorId) isAuthorized = true;\n    if (!isAuthorized) {\n      const { data: pm } = await supabaseAdmin.from('project_members').select('role').eq('project_id', linkData.project_id).eq('member_id', actorId).limit(1);\n      if (pm && pm.length > 0 && (pm[0].role === 'owner' || pm[0].role === 'manage')) isAuthorized = true;\n    }\n    if (!isAuthorized) return NextResponse.json({ error: 'Forbidden' }, { status: 403 });\n\n    const { error } = await supabaseAdmin.from('share_links').update({ revoked_at: new Date().toISOString() }).eq('id', id);\n    if (error) return NextResponse.json({ error: error.message }, { status: 500 });\n\n    await supabaseAdmin.from('audit_logs').insert({ actor_id: actorId, action: 'share_link_revoked', target_type: 'share_link', target_id: id, meta: null });\n\n    return NextResponse.json({ success: true }, { status: 200 });\n  } catch (err: any) {\n    console.error('[DELETE /api/projects/share] Error', err);\n    return NextResponse.json({ error: err?.message || 'Unexpected error' }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":"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"}}]
}