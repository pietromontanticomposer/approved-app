{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///Users/pietromontanti/Desktop/approved-clean/Approved/lib/supabaseAdmin.ts"],"sourcesContent":["import { createClient } from \"@supabase/supabase-js\";\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\nconst supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\n\n// Export a variable and assign it below to avoid `export` inside conditionals\nexport let supabaseAdmin: any = null;\n\n// If real env vars are present, use real client. Otherwise, if testing is enabled,\n// provide a lightweight in-memory fake client to allow local tests without secrets.\nif (supabaseUrl && supabaseServiceKey) {\n  // Admin client â€” use only on the server\n  supabaseAdmin = createClient(supabaseUrl, supabaseServiceKey, {\n    auth: { persistSession: false },\n  });\n} else if (process.env.APP_ALLOW_FAKE_SUPABASE === '1') {\n  // Simple in-memory fake DB with minimal API surface used by the server routes.\n  type Row = Record<string, any>;\n  const db: Record<string, Row[]> = {\n    projects: [\n      { id: 'p1', team_id: 't1', owner_id: 'owner-1', name: 'Test Project' },\n    ],\n    share_links: [],\n    project_members: [],\n    team_members: [ { team_id: 't1', user_id: 'owner-1', role: 'owner' } ],\n    audit_logs: [],\n  };\n\n  const { v4: uuidv4 } = require('uuid');\n  function clone(obj: any) { return JSON.parse(JSON.stringify(obj)); }\n\n  function createFrom(tableName: string) {\n    const q: any = {\n      _table: tableName,\n      _select: '*',\n      _where: [] as Array<{k:string,v:any}>,\n      _limit: null as number | null,\n      select(cols?: string) { q._select = cols || '*'; return q; },\n      eq(k: string, v: any) { q._where.push({k,v}); return q; },\n      limit(n: number) { q._limit = n; return q; },\n      maybeSingle: async () => {\n        const rows = db[tableName] || [];\n        const filtered = rows.filter(r => q._where.every(w => String(r[w.k]) === String(w.v)));\n        return { data: filtered.length>0 ? clone(filtered[0]) : null, error: null };\n      },\n      insert: (payload: any) => {\n        const rows = db[tableName] || (db[tableName] = []);\n        const toInsert = Array.isArray(payload) ? payload : [payload];\n        const inserted = toInsert.map((p: any) => {\n          const row = Object.assign({}, p);\n          if (!row.id) row.id = uuidv4();\n          row.created_at = new Date().toISOString();\n          rows.push(row);\n          return row;\n        });\n        return {\n          data: inserted,\n          error: null,\n          select: () => ({\n            single: async () => ({ data: inserted[0], error: null })\n          })\n        };\n      },\n      update: (payload: any) => {\n        // return chainable object supporting .eq(k,v)\n        return {\n          eq: async (k: string, v: any) => {\n            const rows = db[tableName] || [];\n            let updatedCount = 0;\n            for (const r of rows) {\n              if (q._where.every(w => String(r[w.k]) === String(w.v)) && String(r[k]) === String(v)) {\n                Object.assign(r, payload);\n                updatedCount++;\n              }\n            }\n            return { data: updatedCount>0 ? rows.filter(r => (q._where.every(w => String(r[w.k]) === String(w.v)) && String(r[k]) === String(v))) : [], error: null };\n          }\n        };\n      },\n      upsert: async (payload: any, opts?: any) => {\n        const rows = db[tableName] || (db[tableName] = []);\n        // naive onConflict by project_id,member_id\n        const existing = rows.find(r => r.project_id === payload.project_id && r.member_id === payload.member_id);\n        if (existing) {\n          Object.assign(existing, payload);\n          return { data: [existing], error: null };\n        }\n        const row = Object.assign({}, payload);\n        if (!row.id) row.id = uuidv4();\n        rows.push(row);\n        return { data: [row], error: null };\n      },\n      single: async () => {\n        const rows = db[tableName] || [];\n        const filtered = rows.filter(r => q._where.every(w => String(r[w.k]) === String(w.v)));\n        return { data: filtered[0] || null, error: null };\n      }\n    };\n    return q;\n  }\n\n  const fakeAdmin = {\n    from: (table: string) => createFrom(table),\n  };\n\n  supabaseAdmin = fakeAdmin as any;\n} else {\n  throw new Error(\n    \"Missing NEXT_PUBLIC_SUPABASE_URL or SUPABASE_SERVICE_ROLE_KEY in environment. Set APP_ALLOW_FAKE_SUPABASE=1 to enable a local fake client for tests.\"\n  );\n}\n\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 211, "column": 0}, "map": {"version":3,"sources":["file:///Users/pietromontanti/Desktop/approved-clean/Approved/lib/supabaseClient.ts"],"sourcesContent":["// lib/supabaseClient.ts\nimport { createClient } from \"@supabase/supabase-js\";\n\nconst url = process.env.NEXT_PUBLIC_SUPABASE_URL;\nconst anon = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\n\nif (!url || !anon) {\n  throw new Error(\n    \"[supabaseClient] Missing NEXT_PUBLIC_SUPABASE_URL or NEXT_PUBLIC_SUPABASE_ANON_KEY\"\n  );\n}\n\n// CRITICAL: This must work in browser AND server contexts\n// Server-side: just for type exports, won't actually use auth\n// Client-side: full auth with localStorage persistence\nlet supabaseInstance: any = null;\n\nexport function getSupabaseClient() {\n  // Only initialize on browser\n  if (typeof window === 'undefined') {\n    return createClient(url, anon);\n  }\n\n  if (!supabaseInstance) {\n    supabaseInstance = createClient(url, anon, {\n      auth: {\n        persistSession: true,\n        storageKey: 'approved-auth',\n        storage: window.localStorage,\n        autoRefreshToken: true,\n        detectSessionInUrl: true\n      }\n    });\n    console.log('[SupabaseClient] Initialized with persistence');\n    \n    // Make available globally\n    (window as any).supabaseClient = supabaseInstance;\n  }\n  \n  return supabaseInstance;\n}\n\n// Default export for backwards compatibility\nexport const supabase = getSupabaseClient();\n\n"],"names":[],"mappings":"AAAA,wBAAwB;;;;;;;AACxB;;AAEA,MAAM;AACN,MAAM;AAEN;;AAMA,0DAA0D;AAC1D,8DAA8D;AAC9D,uDAAuD;AACvD,IAAI,mBAAwB;AAErB,SAAS;IACd,6BAA6B;IAC7B,wCAAmC;QACjC,OAAO,IAAA,yLAAY,EAAC,KAAK;IAC3B;;;AAmBF;AAGO,MAAM,WAAW"}},
    {"offset": {"line": 241, "column": 0}, "map": {"version":3,"sources":["file:///Users/pietromontanti/Desktop/approved-clean/Approved/lib/auth.ts"],"sourcesContent":["// lib/auth.ts\nimport { supabase } from \"./supabaseClient\";\nimport { supabaseAdmin } from \"./supabaseAdmin\";\nimport { NextRequest } from 'next/server';\n\n// =======================\n// CLIENT-SIDE AUTH\n// =======================\n\n/**\n * Ottiene l'utente autenticato corrente (CLIENT-SIDE)\n */\nexport async function getCurrentUser() {\n  const { data: { user }, error } = await supabase.auth.getUser();\n\n  if (error || !user) {\n    return null;\n  }\n\n  return user;\n}\n\n// =======================\n// SERVER-SIDE AUTH\n// =======================\n\nexport interface AuthContext {\n  userId: string;\n  email: string;\n  isAuthenticated: boolean;\n}\n\n/**\n * Verify authentication from request headers (SERVER-SIDE)\n * CRITICAL: This function MUST be used on all protected API routes\n *\n * Verification flow:\n * 1. Extract Bearer token from Authorization header\n * 2. Verify token with Supabase auth\n * 3. Return authenticated user ID\n *\n * DO NOT trust x-actor-id header - it can be spoofed by clients\n */\nexport async function verifyAuth(req: NextRequest): Promise<AuthContext | null> {\n  try {\n    // Extract Bearer token from Authorization header\n    const authHeader = req.headers.get('authorization');\n    if (!authHeader || !authHeader.startsWith('Bearer ')) {\n      console.log('[Auth] No valid authorization header found');\n      return null;\n    }\n\n    const token = authHeader.substring(7); // Remove \"Bearer \" prefix\n    if (!token) {\n      console.log('[Auth] Empty token');\n      return null;\n    }\n\n    // Verify token with Supabase\n    const { data, error } = await supabaseAdmin.auth.getUser(token);\n\n    if (error || !data.user) {\n      console.log('[Auth] Token verification failed:', error?.message);\n      return null;\n    }\n\n    return {\n      userId: data.user.id,\n      email: data.user.email || '',\n      isAuthenticated: true,\n    };\n  } catch (err) {\n    console.error('[Auth] Unexpected error during auth verification:', err);\n    return null;\n  }\n}\n\n/**\n * Get authenticated user ID or throw 401 error (SERVER-SIDE)\n * Use this in API routes that REQUIRE authentication\n */\nexport async function requireAuth(req: NextRequest): Promise<string> {\n  const auth = await verifyAuth(req);\n  if (!auth) {\n    throw new Error('UNAUTHORIZED');\n  }\n  return auth.userId;\n}\n\n/**\n * Check if user has permission to access a project (SERVER-SIDE)\n * Returns true if user is owner or team member\n */\nexport async function canAccessProject(userId: string, projectId: string): Promise<boolean> {\n  try {\n    // Check if user owns the project\n    const { data: project, error: projectError } = await supabaseAdmin\n      .from('projects')\n      .select('owner_id, team_id')\n      .eq('id', projectId)\n      .single();\n\n    if (projectError || !project) {\n      return false;\n    }\n\n    // User is owner\n    if (project.owner_id === userId) {\n      return true;\n    }\n\n    // Check if user is in project_members\n    const { data: member } = await supabaseAdmin\n      .from('project_members')\n      .select('id')\n      .eq('project_id', projectId)\n      .eq('member_id', userId)\n      .maybeSingle();\n\n    if (member) {\n      return true;\n    }\n\n    // Check if user is in team\n    if (project.team_id) {\n      const { data: teamMember } = await supabaseAdmin\n        .from('team_members')\n        .select('id')\n        .eq('team_id', project.team_id)\n        .eq('user_id', userId)\n        .maybeSingle();\n\n      if (teamMember) {\n        return true;\n      }\n    }\n\n    return false;\n  } catch (err) {\n    console.error('[Auth] Error checking project access:', err);\n    return false;\n  }\n}\n\n/**\n * Check if user can modify a project (owner or admin) (SERVER-SIDE)\n */\nexport async function canModifyProject(userId: string, projectId: string): Promise<boolean> {\n  try {\n    const { data: project } = await supabaseAdmin\n      .from('projects')\n      .select('owner_id, team_id')\n      .eq('id', projectId)\n      .single();\n\n    if (!project) {\n      return false;\n    }\n\n    // Only owner can modify\n    if (project.owner_id === userId) {\n      return true;\n    }\n\n    // Check if user is admin in team\n    if (project.team_id) {\n      const { data: teamMember } = await supabaseAdmin\n        .from('team_members')\n        .select('role')\n        .eq('team_id', project.team_id)\n        .eq('user_id', userId)\n        .maybeSingle();\n\n      if (teamMember && teamMember.role === 'admin') {\n        return true;\n      }\n    }\n\n    return false;\n  } catch (err) {\n    console.error('[Auth] Error checking modify permission:', err);\n    return false;\n  }\n}\n\n/**\n * Ottiene il primo team dell'utente (tipicamente il workspace personale)\n */\nexport async function getUserDefaultTeam(userId: string) {\n  const { data, error } = await supabase\n    .from(\"team_members\")\n    .select(\"team_id, role, teams(id, name)\")\n    .eq(\"user_id\", userId)\n    .order(\"joined_at\", { ascending: true })\n    .limit(1)\n    .single();\n\n  if (error || !data) {\n    return null;\n  }\n\n  return {\n    teamId: data.team_id,\n    role: data.role,\n    teamName: (data.teams as any)?.name || \"My Workspace\",\n  };\n}\n\n/**\n * Ottiene tutti i team dell'utente\n */\nexport async function getUserTeams(userId: string) {\n  const { data, error } = await supabase\n    .from(\"team_members\")\n    .select(\"team_id, role, joined_at, teams(id, name, description)\")\n    .eq(\"user_id\", userId)\n    .order(\"joined_at\", { ascending: true });\n\n  if (error || !data) {\n    return [];\n  }\n\n  return data.map((tm) => ({\n    teamId: tm.team_id,\n    role: tm.role,\n    joinedAt: tm.joined_at,\n    team: tm.teams as any,\n  }));\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 388, "column": 0}, "map": {"version":3,"sources":["file:///Users/pietromontanti/Desktop/approved-clean/Approved/app/api/projects/route.ts"],"sourcesContent":["// app/api/projects/route.ts\n/**\n * Projects API Route\n *\n * Secure, professional implementation with:\n * - Server-side authentication verification\n * - Proper authorization checks\n * - Input validation\n * - Error handling\n * - Type safety\n */\n\nimport { NextResponse } from \"next/server\";\nimport { NextRequest } from \"next/server\";\nimport { supabaseAdmin } from \"@/lib/supabaseAdmin\";\nimport { verifyAuth, canModifyProject, canAccessProject } from '@/lib/auth';\n\n// ============================================================================\n// TYPES\n// ============================================================================\n\ntype Project = {\n  id: string;\n  name: string;\n  description: string | null;\n  created_at: string;\n  updated_at: string;\n  team_id: string | null;\n  owner_id: string | null;\n};\n\ntype ProjectWithMembers = Project & {\n  team_members: TeamMember[];\n};\n\ntype TeamMember = {\n  user_id: string;\n  role: string;\n  joined_at: string;\n};\n\n// ============================================================================\n// HELPER FUNCTIONS\n// ============================================================================\n\n/**\n * Hydrate projects with team member information\n */\nasync function hydrateProjectsWithTeamMembers(projects: Project[]): Promise<ProjectWithMembers[]> {\n  return Promise.all(\n    projects.map(async (project) => {\n      let teamMembers: TeamMember[] = [];\n\n      if (project.team_id) {\n        try {\n          const { data } = await supabaseAdmin\n            .from('team_members')\n            .select('user_id, role, joined_at')\n            .eq('team_id', project.team_id);\n\n          teamMembers = data || [];\n        } catch (err) {\n          console.warn(`[Projects] Warning loading team_members for project ${project.id}:`, err);\n        }\n      }\n\n      return { ...project, team_members: teamMembers };\n    })\n  );\n}\n\n/**\n * Get projects owned by user\n */\nasync function getOwnedProjects(userId: string): Promise<Project[]> {\n  const { data, error } = await supabaseAdmin\n    .from('projects')\n    .select('*')\n    .eq('owner_id', userId)\n    .order('created_at', { ascending: false });\n\n  if (error) {\n    console.error('[Projects] Error loading owned projects:', error);\n    throw new Error(`Failed to load owned projects: ${error.message}`);\n  }\n\n  return data || [];\n}\n\n/**\n * Get projects shared with user\n */\nasync function getSharedProjects(userId: string, ownedProjectIds: string[]): Promise<Project[]> {\n  // Get project IDs from project_members\n  const { data: membershipRows, error: membershipError } = await supabaseAdmin\n    .from('project_members')\n    .select('project_id')\n    .eq('member_id', userId);\n\n  if (membershipError) {\n    console.error('[Projects] Error loading project memberships:', membershipError);\n    throw new Error(`Failed to load project memberships: ${membershipError.message}`);\n  }\n\n  const projectIdsFromMembership = (membershipRows || [])\n    .map(r => r.project_id)\n    .filter(Boolean);\n\n  // Get team IDs for user\n  const { data: teamRows, error: teamError } = await supabaseAdmin\n    .from('team_members')\n    .select('team_id')\n    .eq('user_id', userId);\n\n  if (teamError) {\n    console.error('[Projects] Error loading team memberships:', teamError);\n    throw new Error(`Failed to load team memberships: ${teamError.message}`);\n  }\n\n  const teamIds = (teamRows || []).map(t => t.team_id).filter(Boolean);\n\n  // Get project IDs from teams\n  let projectIdsFromTeams: string[] = [];\n  if (teamIds.length > 0) {\n    const { data: teamProjects, error: teamProjectsError } = await supabaseAdmin\n      .from('projects')\n      .select('id')\n      .in('team_id', teamIds);\n\n    if (teamProjectsError) {\n      console.error('[Projects] Error loading team projects:', teamProjectsError);\n      throw new Error(`Failed to load team projects: ${teamProjectsError.message}`);\n    }\n\n    projectIdsFromTeams = (teamProjects || []).map(p => p.id).filter(Boolean);\n  }\n\n  // Combine and deduplicate, excluding owned projects\n  const allSharedIds = new Set([...projectIdsFromMembership, ...projectIdsFromTeams]);\n  const ownedIdsSet = new Set(ownedProjectIds);\n  const finalSharedIds = Array.from(allSharedIds).filter(id => !ownedIdsSet.has(id));\n\n  if (finalSharedIds.length === 0) {\n    return [];\n  }\n\n  // Fetch shared projects\n  const { data: sharedProjects, error: sharedError } = await supabaseAdmin\n    .from('projects')\n    .select('*')\n    .in('id', finalSharedIds)\n    .order('created_at', { ascending: false});\n\n  if (sharedError) {\n    console.error('[Projects] Error loading shared projects:', sharedError);\n    throw new Error(`Failed to load shared projects: ${sharedError.message}`);\n  }\n\n  return sharedProjects || [];\n}\n\n// ============================================================================\n// API ROUTES\n// ============================================================================\n\n/**\n * GET /api/projects\n *\n * Returns user's owned and shared projects\n * Requires: Authentication\n * Returns: { my_projects: Project[], shared_with_me: Project[], projects: Project[] }\n */\nexport async function GET(req: NextRequest) {\n  try {\n    console.log('[GET /api/projects] Request started');\n\n    // SECURITY: Verify authentication\n    const auth = await verifyAuth(req);\n    if (!auth) {\n      console.log('[GET /api/projects] Unauthorized request');\n      return NextResponse.json(\n        { error: 'Unauthorized - authentication required' },\n        { status: 401 }\n      );\n    }\n\n    const userId = auth.userId;\n    console.log('[GET /api/projects] Authenticated user:', userId);\n\n    // Fetch owned projects\n    const ownedProjects = await getOwnedProjects(userId);\n    console.log('[GET /api/projects] Found', ownedProjects.length, 'owned projects');\n\n    // Fetch shared projects\n    const ownedProjectIds = ownedProjects.map(p => p.id);\n    const sharedProjects = await getSharedProjects(userId, ownedProjectIds);\n    console.log('[GET /api/projects] Found', sharedProjects.length, 'shared projects');\n\n    // Hydrate with team member info\n    const myProjectsHydrated = await hydrateProjectsWithTeamMembers(ownedProjects);\n    const sharedProjectsHydrated = await hydrateProjectsWithTeamMembers(sharedProjects);\n\n    // Combine for backward compatibility\n    const allProjects = [...myProjectsHydrated, ...sharedProjectsHydrated];\n\n    return NextResponse.json({\n      my_projects: myProjectsHydrated,\n      shared_with_me: sharedProjectsHydrated,\n      projects: allProjects, // Backward compatibility\n    }, { status: 200 });\n\n  } catch (err: any) {\n    console.error('[GET /api/projects] Error:', err);\n    return NextResponse.json(\n      { error: err?.message || 'Internal server error' },\n      { status: 500 }\n    );\n  }\n}\n\n/**\n * POST /api/projects\n *\n * Creates a new project\n * Requires: Authentication\n * Body: { name: string, description?: string, team_id?: string }\n * Returns: { project: Project }\n */\nexport async function POST(req: NextRequest) {\n  try {\n    console.log('[POST /api/projects] Request started');\n\n    // SECURITY: Verify authentication\n    const auth = await verifyAuth(req);\n    if (!auth) {\n      console.log('[POST /api/projects] Unauthorized request');\n      return NextResponse.json(\n        { error: 'Unauthorized - authentication required' },\n        { status: 401 }\n      );\n    }\n\n    const userId = auth.userId;\n\n    // Parse and validate request body\n    let body: any;\n    try {\n      body = await req.json();\n    } catch (err) {\n      console.error('[POST /api/projects] Invalid JSON:', err);\n      return NextResponse.json(\n        { error: 'Invalid JSON in request body' },\n        { status: 400 }\n      );\n    }\n\n    const name = typeof body.name === 'string' ? body.name.trim() : '';\n    const description = typeof body.description === 'string' ? body.description.trim() : '';\n    let teamId = typeof body.team_id === 'string' ? body.team_id : 'auto';\n\n    // Validate required fields\n    if (!name) {\n      return NextResponse.json(\n        { error: 'Project name is required' },\n        { status: 400 }\n      );\n    }\n\n    // Handle auto team assignment\n    if (teamId === 'auto') {\n      console.log('[POST /api/projects] Auto-assigning team');\n\n      // Find user's first team\n      const { data: userTeams } = await supabaseAdmin\n        .from('team_members')\n        .select('team_id')\n        .eq('user_id', userId)\n        .limit(1)\n        .single();\n\n      if (userTeams?.team_id) {\n        teamId = userTeams.team_id;\n        console.log('[POST /api/projects] Using existing team:', teamId);\n      } else {\n        // Create personal workspace\n        const { data: newTeam, error: teamError } = await supabaseAdmin\n          .from('teams')\n          .insert({\n            name: 'My Workspace',\n            owner_id: userId\n          })\n          .select()\n          .single();\n\n        if (teamError) {\n          console.error('[POST /api/projects] Error creating team:', teamError);\n          return NextResponse.json(\n            { error: 'Failed to create workspace' },\n            { status: 500 }\n          );\n        }\n\n        teamId = newTeam.id;\n        console.log('[POST /api/projects] Created new team:', teamId);\n\n        // Add user as team member\n        await supabaseAdmin\n          .from('team_members')\n          .insert({\n            team_id: teamId,\n            user_id: userId,\n            role: 'admin'\n          });\n      }\n    }\n\n    // Create project\n    const { data: project, error: createError } = await supabaseAdmin\n      .from('projects')\n      .insert({\n        name,\n        description: description || null,\n        team_id: teamId,\n        owner_id: userId\n      })\n      .select()\n      .single();\n\n    if (createError) {\n      console.error('[POST /api/projects] Error creating project:', createError);\n      return NextResponse.json(\n        { error: `Failed to create project: ${createError.message}` },\n        { status: 500 }\n      );\n    }\n\n    // Add creator as project member\n    try {\n      await supabaseAdmin\n        .from('project_members')\n        .upsert({\n          project_id: project.id,\n          member_id: userId,\n          role: 'owner',\n          added_by: userId\n        }, {\n          onConflict: 'project_id,member_id'\n        });\n    } catch (err) {\n      console.warn('[POST /api/projects] Warning adding project membership:', err);\n    }\n\n    console.log('[POST /api/projects] Project created:', project.id);\n    return NextResponse.json({ project }, { status: 201 });\n\n  } catch (err: any) {\n    console.error('[POST /api/projects] Error:', err);\n    return NextResponse.json(\n      { error: err?.message || 'Internal server error' },\n      { status: 500 }\n    );\n  }\n}\n\n/**\n * PATCH /api/projects\n *\n * Updates a project's name or description\n * Requires: Authentication + ownership/admin permission\n * Body: { id: string, name?: string, description?: string }\n * Returns: { project: Project }\n */\nexport async function PATCH(req: NextRequest) {\n  try {\n    console.log('[PATCH /api/projects] Request started');\n\n    // SECURITY: Verify authentication\n    const auth = await verifyAuth(req);\n    if (!auth) {\n      console.log('[PATCH /api/projects] Unauthorized request');\n      return NextResponse.json(\n        { error: 'Unauthorized - authentication required' },\n        { status: 401 }\n      );\n    }\n\n    const userId = auth.userId;\n\n    // Parse and validate request body\n    let body: any;\n    try {\n      body = await req.json();\n    } catch (err) {\n      console.error('[PATCH /api/projects] Invalid JSON:', err);\n      return NextResponse.json(\n        { error: 'Invalid JSON in request body' },\n        { status: 400 }\n      );\n    }\n\n    const projectId = typeof body.id === 'string' ? body.id.trim() : '';\n    const name = typeof body.name === 'string' ? body.name.trim() : null;\n    const description = typeof body.description === 'string' ? body.description.trim() : null;\n\n    if (!projectId) {\n      return NextResponse.json(\n        { error: 'Project ID is required' },\n        { status: 400 }\n      );\n    }\n\n    // SECURITY: Check if user can modify this project\n    const canModify = await canModifyProject(userId, projectId);\n    if (!canModify) {\n      console.log('[PATCH /api/projects] User not authorized to modify project');\n      return NextResponse.json(\n        { error: 'Forbidden - you do not have permission to modify this project' },\n        { status: 403 }\n      );\n    }\n\n    // Build update object\n    const updates: any = {};\n    if (name !== null) updates.name = name;\n    if (description !== null) updates.description = description;\n\n    if (Object.keys(updates).length === 0) {\n      return NextResponse.json(\n        { error: 'Nothing to update' },\n        { status: 400 }\n      );\n    }\n\n    // Update project\n    const { data: project, error: updateError } = await supabaseAdmin\n      .from('projects')\n      .update(updates)\n      .eq('id', projectId)\n      .select()\n      .single();\n\n    if (updateError) {\n      console.error('[PATCH /api/projects] Error updating project:', updateError);\n      return NextResponse.json(\n        { error: `Failed to update project: ${updateError.message}` },\n        { status: 500 }\n      );\n    }\n\n    console.log('[PATCH /api/projects] Project updated:', projectId);\n    return NextResponse.json({ project }, { status: 200 });\n\n  } catch (err: any) {\n    console.error('[PATCH /api/projects] Error:', err);\n    return NextResponse.json(\n      { error: err?.message || 'Internal server error' },\n      { status: 500 }\n    );\n  }\n}\n\n/**\n * DELETE /api/projects\n *\n * Deletes a project\n * Requires: Authentication + ownership/admin permission\n * Query: ?id=<project_id> OR Body: { id: string }\n * Returns: { success: true }\n */\nexport async function DELETE(req: NextRequest) {\n  try {\n    console.log('[DELETE /api/projects] Request started');\n\n    // SECURITY: Verify authentication\n    const auth = await verifyAuth(req);\n    if (!auth) {\n      console.log('[DELETE /api/projects] Unauthorized request');\n      return NextResponse.json(\n        { error: 'Unauthorized - authentication required' },\n        { status: 401 }\n      );\n    }\n\n    const userId = auth.userId;\n\n    // Get project ID from query or body\n    const url = new URL(req.url);\n    let projectId = url.searchParams.get('id') || '';\n\n    if (!projectId) {\n      try {\n        const body = await req.json();\n        projectId = typeof body.id === 'string' ? body.id.trim() : '';\n      } catch (err) {\n        // Body parsing failed, continue with empty projectId\n      }\n    }\n\n    if (!projectId) {\n      return NextResponse.json(\n        { error: 'Project ID is required' },\n        { status: 400 }\n      );\n    }\n\n    // SECURITY: Check if user can modify this project\n    const canModify = await canModifyProject(userId, projectId);\n    if (!canModify) {\n      console.log('[DELETE /api/projects] User not authorized to delete project');\n      return NextResponse.json(\n        { error: 'Forbidden - you do not have permission to delete this project' },\n        { status: 403 }\n      );\n    }\n\n    // Delete project (cascade will handle related records)\n    const { error: deleteError } = await supabaseAdmin\n      .from('projects')\n      .delete()\n      .eq('id', projectId);\n\n    if (deleteError) {\n      console.error('[DELETE /api/projects] Error deleting project:', deleteError);\n      return NextResponse.json(\n        { error: `Failed to delete project: ${deleteError.message}` },\n        { status: 500 }\n      );\n    }\n\n    console.log('[DELETE /api/projects] Project deleted:', projectId);\n    return NextResponse.json({ success: true }, { status: 200 });\n\n  } catch (err: any) {\n    console.error('[DELETE /api/projects] Error:', err);\n    return NextResponse.json(\n      { error: err?.message || 'Internal server error' },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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"}}]
}