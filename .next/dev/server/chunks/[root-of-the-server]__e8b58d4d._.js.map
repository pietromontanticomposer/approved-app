{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///Users/pietromontanti/Desktop/approved-clean/Approved/lib/supabaseAdmin.ts"],"sourcesContent":["import { createClient } from \"@supabase/supabase-js\";\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\nconst supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\n\n// Export a variable and assign it below to avoid `export` inside conditionals\nexport let supabaseAdmin: any = null;\n\n// If real env vars are present, use real client. Otherwise, if testing is enabled,\n// provide a lightweight in-memory fake client to allow local tests without secrets.\nif (supabaseUrl && supabaseServiceKey) {\n  // Admin client â€” use only on the server\n  supabaseAdmin = createClient(supabaseUrl, supabaseServiceKey, {\n    auth: { persistSession: false },\n  });\n} else if (process.env.APP_ALLOW_FAKE_SUPABASE === '1') {\n  // Simple in-memory fake DB with minimal API surface used by the server routes.\n  type Row = Record<string, any>;\n  const db: Record<string, Row[]> = {\n    projects: [\n      { id: 'p1', team_id: 't1', owner_id: 'owner-1', name: 'Test Project' },\n    ],\n    share_links: [],\n    project_members: [],\n    team_members: [ { team_id: 't1', user_id: 'owner-1', role: 'owner' } ],\n    audit_logs: [],\n  };\n\n  const { v4: uuidv4 } = require('uuid');\n  function clone(obj: any) { return JSON.parse(JSON.stringify(obj)); }\n\n  function createFrom(tableName: string) {\n    const q: any = {\n      _table: tableName,\n      _select: '*',\n      _where: [] as Array<{k:string,v:any}>,\n      _limit: null as number | null,\n      select(cols?: string) { q._select = cols || '*'; return q; },\n      eq(k: string, v: any) { q._where.push({k,v}); return q; },\n      limit(n: number) { q._limit = n; return q; },\n      maybeSingle: async () => {\n        const rows = db[tableName] || [];\n        const filtered = rows.filter(r => q._where.every(w => String(r[w.k]) === String(w.v)));\n        return { data: filtered.length>0 ? clone(filtered[0]) : null, error: null };\n      },\n      insert: (payload: any) => {\n        const rows = db[tableName] || (db[tableName] = []);\n        const toInsert = Array.isArray(payload) ? payload : [payload];\n        const inserted = toInsert.map((p: any) => {\n          const row = Object.assign({}, p);\n          if (!row.id) row.id = uuidv4();\n          row.created_at = new Date().toISOString();\n          rows.push(row);\n          return row;\n        });\n        return {\n          data: inserted,\n          error: null,\n          select: () => ({\n            single: async () => ({ data: inserted[0], error: null })\n          })\n        };\n      },\n      update: (payload: any) => {\n        // return chainable object supporting .eq(k,v)\n        return {\n          eq: async (k: string, v: any) => {\n            const rows = db[tableName] || [];\n            let updatedCount = 0;\n            for (const r of rows) {\n              if (q._where.every(w => String(r[w.k]) === String(w.v)) && String(r[k]) === String(v)) {\n                Object.assign(r, payload);\n                updatedCount++;\n              }\n            }\n            return { data: updatedCount>0 ? rows.filter(r => (q._where.every(w => String(r[w.k]) === String(w.v)) && String(r[k]) === String(v))) : [], error: null };\n          }\n        };\n      },\n      upsert: async (payload: any, opts?: any) => {\n        const rows = db[tableName] || (db[tableName] = []);\n        // naive onConflict by project_id,member_id\n        const existing = rows.find(r => r.project_id === payload.project_id && r.member_id === payload.member_id);\n        if (existing) {\n          Object.assign(existing, payload);\n          return { data: [existing], error: null };\n        }\n        const row = Object.assign({}, payload);\n        if (!row.id) row.id = uuidv4();\n        rows.push(row);\n        return { data: [row], error: null };\n      },\n      single: async () => {\n        const rows = db[tableName] || [];\n        const filtered = rows.filter(r => q._where.every(w => String(r[w.k]) === String(w.v)));\n        return { data: filtered[0] || null, error: null };\n      }\n    };\n    return q;\n  }\n\n  const fakeAdmin = {\n    from: (table: string) => createFrom(table),\n  };\n\n  supabaseAdmin = fakeAdmin as any;\n} else {\n  throw new Error(\n    \"Missing NEXT_PUBLIC_SUPABASE_URL or SUPABASE_SERVICE_ROLE_KEY in environment. Set APP_ALLOW_FAKE_SUPABASE=1 to enable a local fake client for tests.\"\n  );\n}\n\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 211, "column": 0}, "map": {"version":3,"sources":["file:///Users/pietromontanti/Desktop/approved-clean/Approved/lib/supabaseClient.ts"],"sourcesContent":["// lib/supabaseClient.ts\nimport { createClient } from \"@supabase/supabase-js\";\n\nconst url = process.env.NEXT_PUBLIC_SUPABASE_URL;\nconst anon = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\n\nif (!url || !anon) {\n  throw new Error(\n    \"[supabaseClient] Missing NEXT_PUBLIC_SUPABASE_URL or NEXT_PUBLIC_SUPABASE_ANON_KEY\"\n  );\n}\n\n// CRITICAL: This must work in browser AND server contexts\n// Server-side: just for type exports, won't actually use auth\n// Client-side: full auth with localStorage persistence\nlet supabaseInstance: any = null;\n\nexport function getSupabaseClient() {\n  // Only initialize on browser\n  if (typeof window === 'undefined') {\n    return createClient(url, anon);\n  }\n\n  if (!supabaseInstance) {\n    supabaseInstance = createClient(url, anon, {\n      auth: {\n        persistSession: true,\n        storageKey: 'approved-auth',\n        storage: window.localStorage,\n        autoRefreshToken: true,\n        detectSessionInUrl: true\n      }\n    });\n    console.log('[SupabaseClient] Initialized with persistence');\n    \n    // Make available globally\n    (window as any).supabaseClient = supabaseInstance;\n  }\n  \n  return supabaseInstance;\n}\n\n// Default export for backwards compatibility\nexport const supabase = getSupabaseClient();\n\n"],"names":[],"mappings":"AAAA,wBAAwB;;;;;;;AACxB;;AAEA,MAAM;AACN,MAAM;AAEN;;AAMA,0DAA0D;AAC1D,8DAA8D;AAC9D,uDAAuD;AACvD,IAAI,mBAAwB;AAErB,SAAS;IACd,6BAA6B;IAC7B,wCAAmC;QACjC,OAAO,IAAA,yLAAY,EAAC,KAAK;IAC3B;;;AAmBF;AAGO,MAAM,WAAW"}},
    {"offset": {"line": 241, "column": 0}, "map": {"version":3,"sources":["file:///Users/pietromontanti/Desktop/approved-clean/Approved/lib/auth.ts"],"sourcesContent":["// lib/auth.ts\nimport { supabase } from \"./supabaseClient\";\nimport { supabaseAdmin } from \"./supabaseAdmin\";\nimport { NextRequest } from 'next/server';\n\n// =======================\n// CLIENT-SIDE AUTH\n// =======================\n\n/**\n * Ottiene l'utente autenticato corrente (CLIENT-SIDE)\n */\nexport async function getCurrentUser() {\n  const { data: { user }, error } = await supabase.auth.getUser();\n\n  if (error || !user) {\n    return null;\n  }\n\n  return user;\n}\n\n// =======================\n// SERVER-SIDE AUTH\n// =======================\n\nexport interface AuthContext {\n  userId: string;\n  email: string;\n  isAuthenticated: boolean;\n}\n\n/**\n * Verify authentication from request headers (SERVER-SIDE)\n * CRITICAL: This function MUST be used on all protected API routes\n *\n * Verification flow:\n * 1. Extract Bearer token from Authorization header\n * 2. Verify token with Supabase auth\n * 3. Return authenticated user ID\n *\n * DO NOT trust x-actor-id header - it can be spoofed by clients\n */\nexport async function verifyAuth(req: NextRequest): Promise<AuthContext | null> {\n  try {\n    // Extract Bearer token from Authorization header\n    const authHeader = req.headers.get('authorization');\n    if (!authHeader || !authHeader.startsWith('Bearer ')) {\n      console.log('[Auth] No valid authorization header found');\n      return null;\n    }\n\n    const token = authHeader.substring(7); // Remove \"Bearer \" prefix\n    if (!token) {\n      console.log('[Auth] Empty token');\n      return null;\n    }\n\n    // Verify token with Supabase\n    const { data, error } = await supabaseAdmin.auth.getUser(token);\n\n    if (error || !data.user) {\n      console.log('[Auth] Token verification failed:', error?.message);\n      return null;\n    }\n\n    return {\n      userId: data.user.id,\n      email: data.user.email || '',\n      isAuthenticated: true,\n    };\n  } catch (err) {\n    console.error('[Auth] Unexpected error during auth verification:', err);\n    return null;\n  }\n}\n\n/**\n * Get authenticated user ID or throw 401 error (SERVER-SIDE)\n * Use this in API routes that REQUIRE authentication\n */\nexport async function requireAuth(req: NextRequest): Promise<string> {\n  const auth = await verifyAuth(req);\n  if (!auth) {\n    throw new Error('UNAUTHORIZED');\n  }\n  return auth.userId;\n}\n\n/**\n * Check if user has permission to access a project (SERVER-SIDE)\n * Returns true if user is owner or team member\n */\nexport async function canAccessProject(userId: string, projectId: string): Promise<boolean> {\n  try {\n    // Check if user owns the project\n    const { data: project, error: projectError } = await supabaseAdmin\n      .from('projects')\n      .select('owner_id, team_id')\n      .eq('id', projectId)\n      .single();\n\n    if (projectError || !project) {\n      return false;\n    }\n\n    // User is owner\n    if (project.owner_id === userId) {\n      return true;\n    }\n\n    // Check if user is in project_members\n    const { data: member } = await supabaseAdmin\n      .from('project_members')\n      .select('id')\n      .eq('project_id', projectId)\n      .eq('member_id', userId)\n      .maybeSingle();\n\n    if (member) {\n      return true;\n    }\n\n    // Check if user is in team\n    if (project.team_id) {\n      const { data: teamMember } = await supabaseAdmin\n        .from('team_members')\n        .select('id')\n        .eq('team_id', project.team_id)\n        .eq('user_id', userId)\n        .maybeSingle();\n\n      if (teamMember) {\n        return true;\n      }\n    }\n\n    return false;\n  } catch (err) {\n    console.error('[Auth] Error checking project access:', err);\n    return false;\n  }\n}\n\n/**\n * Check if user can modify a project (owner or admin) (SERVER-SIDE)\n */\nexport async function canModifyProject(userId: string, projectId: string): Promise<boolean> {\n  try {\n    const { data: project } = await supabaseAdmin\n      .from('projects')\n      .select('owner_id, team_id')\n      .eq('id', projectId)\n      .single();\n\n    if (!project) {\n      return false;\n    }\n\n    // Only owner can modify\n    if (project.owner_id === userId) {\n      return true;\n    }\n\n    // Check if user is admin in team\n    if (project.team_id) {\n      const { data: teamMember } = await supabaseAdmin\n        .from('team_members')\n        .select('role')\n        .eq('team_id', project.team_id)\n        .eq('user_id', userId)\n        .maybeSingle();\n\n      if (teamMember && teamMember.role === 'admin') {\n        return true;\n      }\n    }\n\n    return false;\n  } catch (err) {\n    console.error('[Auth] Error checking modify permission:', err);\n    return false;\n  }\n}\n\n/**\n * Ottiene il primo team dell'utente (tipicamente il workspace personale)\n */\nexport async function getUserDefaultTeam(userId: string) {\n  const { data, error } = await supabase\n    .from(\"team_members\")\n    .select(\"team_id, role, teams(id, name)\")\n    .eq(\"user_id\", userId)\n    .order(\"joined_at\", { ascending: true })\n    .limit(1)\n    .single();\n\n  if (error || !data) {\n    return null;\n  }\n\n  return {\n    teamId: data.team_id,\n    role: data.role,\n    teamName: (data.teams as any)?.name || \"My Workspace\",\n  };\n}\n\n/**\n * Ottiene tutti i team dell'utente\n */\nexport async function getUserTeams(userId: string) {\n  const { data, error } = await supabase\n    .from(\"team_members\")\n    .select(\"team_id, role, joined_at, teams(id, name, description)\")\n    .eq(\"user_id\", userId)\n    .order(\"joined_at\", { ascending: true });\n\n  if (error || !data) {\n    return [];\n  }\n\n  return data.map((tm) => ({\n    teamId: tm.team_id,\n    role: tm.role,\n    joinedAt: tm.joined_at,\n    team: tm.teams as any,\n  }));\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 388, "column": 0}, "map": {"version":3,"sources":["file:///Users/pietromontanti/Desktop/approved-clean/Approved/app/api/comments/route.ts"],"sourcesContent":["// app/api/comments/route.ts\n/**\n * Comments API Route\n *\n * Secure implementation with:\n * - Server-side authentication verification\n * - Proper authorization checks (user can only edit/delete own comments)\n * - Input validation\n * - Error handling\n * - Type safety\n */\n\nimport { NextResponse, NextRequest } from \"next/server\";\nimport { v4 as uuidv4 } from \"uuid\";\nimport { supabaseAdmin } from \"@/lib/supabaseAdmin\";\nimport { verifyAuth } from '@/lib/auth';\n\n// ============================================================================\n// TYPES\n// ============================================================================\n\ntype Comment = {\n  id: string;\n  version_id: string;\n  time_seconds: number;\n  author: string | null;\n  actor_id: string | null;\n  text: string;\n  created_at: string;\n  updated_at: string;\n};\n\n// ============================================================================\n// HELPER FUNCTIONS\n// ============================================================================\n\nconst isUuid = (value: string) =>\n  typeof value === \"string\" &&\n  /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(\n    value\n  );\n\n/**\n * Get user display name from auth metadata\n */\nasync function getUserDisplayName(userId: string): Promise<string | null> {\n  try {\n    const { data: userData } = await supabaseAdmin.auth.admin.getUserById(userId);\n\n    if (!userData?.user?.user_metadata) {\n      return null;\n    }\n\n    const meta = userData.user.user_metadata as any;\n    const first = meta.first_name || meta.firstName || meta.first || '';\n    const last = meta.last_name || meta.lastName || meta.last || '';\n    const display = meta.display_name || meta.full_name || `${first} ${last}`.trim();\n\n    return display || null;\n  } catch (err) {\n    console.warn('[Comments] Error fetching user metadata:', err);\n    return null;\n  }\n}\n\n// ============================================================================\n// API ROUTES\n// ============================================================================\n\n/**\n * GET /api/comments?versionId=xxx\n *\n * Returns comments for a version\n * Requires: Authentication (to ensure user has access to the version/project)\n * Returns: { comments: Comment[] }\n */\nexport async function GET(req: NextRequest) {\n  try {\n    console.log('[GET /api/comments] Request started');\n\n    // SECURITY: Verify authentication\n    const auth = await verifyAuth(req);\n    if (!auth) {\n      console.log('[GET /api/comments] Unauthorized request');\n      return NextResponse.json(\n        { error: 'Unauthorized - authentication required' },\n        { status: 401 }\n      );\n    }\n\n    const url = new URL(req.url);\n    const versionId = url.searchParams.get('versionId');\n\n    if (!versionId) {\n      return NextResponse.json(\n        { error: 'versionId query parameter is required' },\n        { status: 400 }\n      );\n    }\n\n    if (!isUuid(versionId)) {\n      return NextResponse.json(\n        { error: 'versionId must be a valid UUID' },\n        { status: 400 }\n      );\n    }\n\n    // Fetch comments\n    const { data: comments, error } = await supabaseAdmin\n      .from(\"comments\")\n      .select('*')\n      .eq(\"version_id\", versionId)\n      .order(\"created_at\", { ascending: true });\n\n    if (error) {\n      console.error(\"[GET /api/comments] Error:\", error);\n      return NextResponse.json(\n        { error: `Failed to fetch comments: ${error.message}` },\n        { status: 500 }\n      );\n    }\n\n    return NextResponse.json({ comments: comments || [] }, { status: 200 });\n\n  } catch (err: any) {\n    console.error(\"[GET /api/comments] Error:\", err);\n    return NextResponse.json(\n      { error: err?.message || 'Internal server error' },\n      { status: 500 }\n    );\n  }\n}\n\n/**\n * POST /api/comments\n *\n * Creates a new comment\n * Requires: Authentication\n * Body: { version_id: string, time_seconds: number, text: string, author?: string }\n * Returns: { comment: Comment }\n */\nexport async function POST(req: NextRequest) {\n  try {\n    console.log('[POST /api/comments] Request started');\n\n    // SECURITY: Verify authentication\n    const auth = await verifyAuth(req);\n    if (!auth) {\n      console.log('[POST /api/comments] Unauthorized request');\n      return NextResponse.json(\n        { error: 'Unauthorized - authentication required' },\n        { status: 401 }\n      );\n    }\n\n    const userId = auth.userId;\n\n    // Parse and validate request body\n    let body: any;\n    try {\n      body = await req.json();\n    } catch (err) {\n      console.error('[POST /api/comments] Invalid JSON:', err);\n      return NextResponse.json(\n        { error: 'Invalid JSON in request body' },\n        { status: 400 }\n      );\n    }\n\n    const { version_id, time_seconds, author, text } = body;\n\n    // Validate required fields\n    if (!version_id || time_seconds === undefined || !text) {\n      return NextResponse.json(\n        { error: \"version_id, time_seconds, and text are required\" },\n        { status: 400 }\n      );\n    }\n\n    if (!isUuid(version_id)) {\n      return NextResponse.json(\n        { error: \"version_id must be a valid UUID\" },\n        { status: 400 }\n      );\n    }\n\n    if (typeof time_seconds !== 'number' || time_seconds < 0) {\n      return NextResponse.json(\n        { error: \"time_seconds must be a non-negative number\" },\n        { status: 400 }\n      );\n    }\n\n    if (typeof text !== 'string' || text.trim().length === 0) {\n      return NextResponse.json(\n        { error: \"text must be a non-empty string\" },\n        { status: 400 }\n      );\n    }\n\n    // Determine author name\n    let authorName = typeof author === 'string' ? author.trim() : null;\n    if (!authorName) {\n      authorName = await getUserDisplayName(userId);\n    }\n\n    const comment_id = uuidv4();\n\n    // Insert comment with verified actor_id\n    const { data, error: insertError } = await supabaseAdmin\n      .from(\"comments\")\n      .insert({\n        id: comment_id,\n        version_id,\n        time_seconds,\n        author: authorName || \"User\",\n        actor_id: userId, // Verified server-side\n        text: text.trim(),\n      })\n      .select()\n      .single();\n\n    if (insertError) {\n      console.error('[POST /api/comments] Error creating comment:', insertError);\n      return NextResponse.json(\n        { error: `Failed to create comment: ${insertError.message}` },\n        { status: 500 }\n      );\n    }\n\n    console.log('[POST /api/comments] Comment created:', comment_id);\n    return NextResponse.json({ comment: data }, { status: 201 });\n\n  } catch (err: any) {\n    console.error(\"[POST /api/comments] Error:\", err);\n    return NextResponse.json(\n      { error: err?.message || 'Internal server error' },\n      { status: 500 }\n    );\n  }\n}\n\n/**\n * PATCH /api/comments\n *\n * Updates a comment's text\n * Requires: Authentication + ownership (user must be comment author)\n * Body: { id: string, text: string }\n * Returns: { comment: Comment }\n */\nexport async function PATCH(req: NextRequest) {\n  try {\n    console.log('[PATCH /api/comments] Request started');\n\n    // SECURITY: Verify authentication\n    const auth = await verifyAuth(req);\n    if (!auth) {\n      console.log('[PATCH /api/comments] Unauthorized request');\n      return NextResponse.json(\n        { error: 'Unauthorized - authentication required' },\n        { status: 401 }\n      );\n    }\n\n    const userId = auth.userId;\n\n    // Parse and validate request body\n    let body: any;\n    try {\n      body = await req.json();\n    } catch (err) {\n      console.error('[PATCH /api/comments] Invalid JSON:', err);\n      return NextResponse.json(\n        { error: 'Invalid JSON in request body' },\n        { status: 400 }\n      );\n    }\n\n    const { id, text } = body;\n\n    if (!id || !text) {\n      return NextResponse.json(\n        { error: \"id and text are required\" },\n        { status: 400 }\n      );\n    }\n\n    if (!isUuid(id)) {\n      return NextResponse.json(\n        { error: \"id must be a valid UUID\" },\n        { status: 400 }\n      );\n    }\n\n    if (typeof text !== 'string' || text.trim().length === 0) {\n      return NextResponse.json(\n        { error: \"text must be a non-empty string\" },\n        { status: 400 }\n      );\n    }\n\n    // SECURITY: Fetch comment and check ownership\n    const { data: existing, error: fetchErr } = await supabaseAdmin\n      .from('comments')\n      .select('id, actor_id')\n      .eq('id', id)\n      .maybeSingle();\n\n    if (fetchErr) {\n      console.error('[PATCH /api/comments] Error fetching comment:', fetchErr);\n      return NextResponse.json(\n        { error: `Failed to fetch comment: ${fetchErr.message}` },\n        { status: 500 }\n      );\n    }\n\n    if (!existing) {\n      return NextResponse.json(\n        { error: 'Comment not found' },\n        { status: 404 }\n      );\n    }\n\n    // Check if comment has actor_id set\n    if (!existing.actor_id) {\n      return NextResponse.json(\n        { error: \"Comment does not have an actor_id; backfill required to enable editing\" },\n        { status: 403 }\n      );\n    }\n\n    // Check ownership\n    if (existing.actor_id !== userId) {\n      console.log('[PATCH /api/comments] User not authorized to edit comment');\n      return NextResponse.json(\n        { error: 'Forbidden - you do not have permission to edit this comment' },\n        { status: 403 }\n      );\n    }\n\n    // Update comment\n    const { data, error: updateError } = await supabaseAdmin\n      .from(\"comments\")\n      .update({ text: text.trim() })\n      .eq(\"id\", id)\n      .select()\n      .single();\n\n    if (updateError) {\n      console.error(\"[PATCH /api/comments] Error updating comment:\", updateError);\n      return NextResponse.json(\n        { error: `Failed to update comment: ${updateError.message}` },\n        { status: 500 }\n      );\n    }\n\n    console.log('[PATCH /api/comments] Comment updated:', id);\n    return NextResponse.json({ comment: data }, { status: 200 });\n\n  } catch (err: any) {\n    console.error(\"[PATCH /api/comments] Error:\", err);\n    return NextResponse.json(\n      { error: err?.message || 'Internal server error' },\n      { status: 500 }\n    );\n  }\n}\n\n/**\n * DELETE /api/comments?id=xxx\n *\n * Deletes a comment\n * Requires: Authentication + ownership (user must be comment author)\n * Query: ?id=<comment_id>\n * Returns: { success: true }\n */\nexport async function DELETE(req: NextRequest) {\n  try {\n    console.log('[DELETE /api/comments] Request started');\n\n    // SECURITY: Verify authentication\n    const auth = await verifyAuth(req);\n    if (!auth) {\n      console.log('[DELETE /api/comments] Unauthorized request');\n      return NextResponse.json(\n        { error: 'Unauthorized - authentication required' },\n        { status: 401 }\n      );\n    }\n\n    const userId = auth.userId;\n\n    // Get comment ID from query\n    const { searchParams } = new URL(req.url);\n    const id = searchParams.get(\"id\");\n\n    if (!id) {\n      return NextResponse.json(\n        { error: \"id query parameter is required\" },\n        { status: 400 }\n      );\n    }\n\n    if (!isUuid(id)) {\n      return NextResponse.json(\n        { error: \"id must be a valid UUID\" },\n        { status: 400 }\n      );\n    }\n\n    // SECURITY: Fetch comment and check ownership\n    const { data: existing, error: fetchErr } = await supabaseAdmin\n      .from('comments')\n      .select('id, actor_id')\n      .eq('id', id)\n      .maybeSingle();\n\n    if (fetchErr) {\n      console.error('[DELETE /api/comments] Error fetching comment:', fetchErr);\n      return NextResponse.json(\n        { error: `Failed to fetch comment: ${fetchErr.message}` },\n        { status: 500 }\n      );\n    }\n\n    if (!existing) {\n      return NextResponse.json(\n        { error: 'Comment not found' },\n        { status: 404 }\n      );\n    }\n\n    // Check if comment has actor_id set\n    if (!existing.actor_id) {\n      return NextResponse.json(\n        { error: \"Comment does not have an actor_id; backfill required to enable deletion\" },\n        { status: 403 }\n      );\n    }\n\n    // Check ownership\n    if (existing.actor_id !== userId) {\n      console.log('[DELETE /api/comments] User not authorized to delete comment');\n      return NextResponse.json(\n        { error: 'Forbidden - you do not have permission to delete this comment' },\n        { status: 403 }\n      );\n    }\n\n    // Delete comment\n    const { error: deleteError } = await supabaseAdmin\n      .from(\"comments\")\n      .delete()\n      .eq(\"id\", id);\n\n    if (deleteError) {\n      console.error(\"[DELETE /api/comments] Error deleting comment:\", deleteError);\n      return NextResponse.json(\n        { error: `Failed to delete comment: ${deleteError.message}` },\n        { status: 500 }\n      );\n    }\n\n    console.log('[DELETE /api/comments] Comment deleted:', id);\n    return NextResponse.json({ success: true }, { status: 200 });\n\n  } catch (err: any) {\n    console.error(\"[DELETE /api/comments] Error:\", err);\n    return NextResponse.json(\n      { error: err?.message || 'Internal server error' },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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"}}]
}