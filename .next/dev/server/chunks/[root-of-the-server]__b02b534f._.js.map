{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/pietromontanti/Desktop/approved-clean/Approved/app/api/invites/route.ts"],"sourcesContent":["// app/api/invites/route.ts\nimport { NextResponse } from \"next/server\";\nimport { createClient } from \"@supabase/supabase-js\";\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;\nconst supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;\n\n/**\n * GET /api/invites?team_id=xxx\n * Lista inviti di un team (solo owner)\n */\nexport async function GET(req: Request) {\n  try {\n    const supabase = createClient(supabaseUrl, supabaseKey);\n    const { data: { user }, error: authError } = await supabase.auth.getUser();\n    \n    if (authError || !user) {\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\n    }\n\n    const url = new URL(req.url);\n    const teamId = url.searchParams.get(\"team_id\");\n\n    if (!teamId) {\n      return NextResponse.json({ error: \"team_id required\" }, { status: 400 });\n    }\n\n    // Verifica che l'utente sia owner del team\n    const { data: membership } = await supabase\n      .from(\"team_members\")\n      .select(\"role\")\n      .eq(\"user_id\", user.id)\n      .eq(\"team_id\", teamId)\n      .single();\n\n    if (!membership || membership.role !== \"owner\") {\n      return NextResponse.json({ error: \"Forbidden\" }, { status: 403 });\n    }\n\n    // Recupera inviti attivi\n    const { data: invites, error } = await supabase\n      .from(\"invites\")\n      .select(\"*\")\n      .eq(\"team_id\", teamId)\n      .eq(\"revoked\", false)\n      .is(\"used_at\", null)\n      .gte(\"expires_at\", new Date().toISOString())\n      .order(\"created_at\", { ascending: false });\n\n    if (error) throw error;\n\n    return NextResponse.json({ invites });\n  } catch (error: any) {\n    console.error(\"Error fetching invites:\", error);\n    return NextResponse.json({ error: error.message }, { status: 500 });\n  }\n}\n\n/**\n * POST /api/invites\n * Crea un nuovo invito\n * Body: { team_id, project_id?, email?, role, is_link_invite }\n */\nexport async function POST(req: Request) {\n  try {\n    const supabase = createClient(supabaseUrl, supabaseKey);\n    const { data: { user }, error: authError } = await supabase.auth.getUser();\n    \n    if (authError || !user) {\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\n    }\n\n    const body = await req.json();\n    const { team_id, project_id, email, role, is_link_invite } = body;\n\n    if (!team_id || !role) {\n      return NextResponse.json(\n        { error: \"team_id and role are required\" },\n        { status: 400 }\n      );\n    }\n\n    if (!is_link_invite && !email) {\n      return NextResponse.json(\n        { error: \"email is required for non-link invites\" },\n        { status: 400 }\n      );\n    }\n\n    // Usa la funzione RPC per creare l'invito\n    const { data, error } = await supabase.rpc(\"create_invite\", {\n      p_team_id: team_id,\n      p_project_id: project_id || null,\n      p_email: email || null,\n      p_role: role,\n      p_is_link_invite: is_link_invite || false,\n      p_invited_by: user.id,\n      p_expires_in_days: 7,\n    });\n\n    if (error) throw error;\n\n    if (!data.success) {\n      return NextResponse.json({ error: data.error }, { status: 400 });\n    }\n\n    return NextResponse.json({\n      success: true,\n      invite_id: data.invite_id,\n      invite_url: `${process.env.NEXT_PUBLIC_APP_URL || req.headers.get(\"origin\")}/invite/${data.invite_id}`,\n    });\n  } catch (error: any) {\n    console.error(\"Error creating invite:\", error);\n    return NextResponse.json({ error: error.message }, { status: 500 });\n  }\n}\n\n/**\n * DELETE /api/invites?invite_id=xxx\n * Revoca un invito\n */\nexport async function DELETE(req: Request) {\n  try {\n    const supabase = createClient(supabaseUrl, supabaseKey);\n    const { data: { user }, error: authError } = await supabase.auth.getUser();\n    \n    if (authError || !user) {\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\n    }\n\n    const url = new URL(req.url);\n    const inviteId = url.searchParams.get(\"invite_id\");\n\n    if (!inviteId) {\n      return NextResponse.json({ error: \"invite_id required\" }, { status: 400 });\n    }\n\n    // Usa la funzione RPC per revocare l'invito\n    const { data, error } = await supabase.rpc(\"revoke_invite\", {\n      invite_token: inviteId,\n      revoking_user_id: user.id,\n    });\n\n    if (error) throw error;\n\n    if (!data.success) {\n      return NextResponse.json({ error: data.error }, { status: 400 });\n    }\n\n    return NextResponse.json({ success: true });\n  } catch (error: any) {\n    console.error(\"Error revoking invite:\", error);\n    return NextResponse.json({ error: error.message }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":"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"}}]
}