{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/pietromontanti/Desktop/approved-clean/Approved/lib/supabaseAdmin.ts"],"sourcesContent":["import { createClient } from \"@supabase/supabase-js\";\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\nconst supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\n\nif (!supabaseUrl || !supabaseServiceKey) {\n  throw new Error(\n    \"Missing NEXT_PUBLIC_SUPABASE_URL or SUPABASE_SERVICE_ROLE_KEY in environment.\"\n  );\n}\n\n// Admin client â€” use only on the server\nexport const supabaseAdmin = createClient(supabaseUrl, supabaseServiceKey, {\n  auth: { persistSession: false },\n});\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM;AACN,MAAM,qBAAqB,QAAQ,GAAG,CAAC,yBAAyB;AAEhE,IAAI,CAAC,eAAe,CAAC,oBAAoB;IACvC,MAAM,IAAI,MACR;AAEJ;AAGO,MAAM,gBAAgB,IAAA,yLAAY,EAAC,aAAa,oBAAoB;IACzE,MAAM;QAAE,gBAAgB;IAAM;AAChC"}},
    {"offset": {"line": 72, "column": 0}, "map": {"version":3,"sources":["file:///Users/pietromontanti/Desktop/approved-clean/Approved/app/api/share/redeem/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\nimport { supabaseAdmin } from \"@/lib/supabaseAdmin\";\nimport crypto from \"crypto\";\n\n/**\n * POST /api/share/redeem\n * Body: { share_id, token }\n * Redeems a share link: validates token, adds user to project_members with the role from the link\n * Header: x-actor-id (user id of the authenticated user)\n */\nexport async function POST(req: Request) {\n  try {\n    const raw = await req.text();\n    if (!raw) return NextResponse.json({ error: 'Empty body' }, { status: 400 });\n    const body = JSON.parse(raw);\n    const shareId = typeof body.share_id === 'string' ? body.share_id : '';\n    const token = typeof body.token === 'string' ? body.token : '';\n    const actorId = req.headers.get('x-actor-id');\n\n    if (!actorId) return NextResponse.json({ error: 'Missing x-actor-id header' }, { status: 403 });\n    if (!shareId || !token) return NextResponse.json({ error: 'share_id and token are required' }, { status: 400 });\n\n    // Load share link by id\n    const { data: linkData, error: linkErr } = await supabaseAdmin.from('share_links').select('*').eq('id', shareId).maybeSingle();\n    if (linkErr || !linkData) return NextResponse.json({ error: 'Share link not found' }, { status: 404 });\n    if (linkData.revoked_at) return NextResponse.json({ error: 'Share link revoked' }, { status: 410 });\n\n    // Check expiry\n    if (linkData.expires_at && new Date(linkData.expires_at) < new Date()) {\n      return NextResponse.json({ error: 'Share link expired' }, { status: 410 });\n    }\n\n    // Check max uses\n    if (linkData.max_uses && linkData.uses >= linkData.max_uses) {\n      return NextResponse.json({ error: 'Share link max uses exceeded' }, { status: 410 });\n    }\n\n    // Verify token by hashing\n    const tokenHash = crypto.createHash('sha256').update(token).digest('hex');\n    if (tokenHash !== linkData.token_hash) {\n      return NextResponse.json({ error: 'Invalid token' }, { status: 403 });\n    }\n\n    // Add to project_members (idempotent upsert)\n    const insert = {\n      project_id: linkData.project_id,\n      member_id: actorId,\n      role: linkData.role || 'view',\n      added_by: linkData.created_by || null,\n    };\n\n    const { error: upsertErr } = await supabaseAdmin.from('project_members').upsert(insert, { onConflict: 'project_id,member_id' });\n    if (upsertErr) return NextResponse.json({ error: upsertErr.message }, { status: 500 });\n\n    // Increment uses\n    await supabaseAdmin.from('share_links').update({ uses: (linkData.uses || 0) + 1 }).eq('id', shareId);\n\n    // Log audit\n    await supabaseAdmin.from('audit_logs').insert({ actor_id: actorId, action: 'share_link_redeemed', target_type: 'project', target_id: linkData.project_id, meta: { share_link_id: shareId } });\n\n    return NextResponse.json({ success: true, project_id: linkData.project_id }, { status: 200 });\n  } catch (err: any) {\n    console.error('[POST /api/share/redeem] Error', err);\n    return NextResponse.json({ error: err?.message || 'Unexpected error' }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":"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"}}]
}