(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,18566,(e,t,r)=>{t.exports=e.r(76562)},33174,e=>{"use strict";var t=e.i(43476),r=e.i(71645),a=e.i(18566);function o(){let o=(0,a.useRouter)(),i=(0,a.useParams)().token,[n,l]=(0,r.useState)(null),[s,c]=(0,r.useState)(null),[d,p]=(0,r.useState)(null),[h,u]=(0,r.useState)(!0),[g,m]=(0,r.useState)(""),[x,y]=(0,r.useState)(!1),[f,j]=(0,r.useState)(""),[S,v]=(0,r.useState)(!1);(0,r.useEffect)(()=>{w()},[i]),(0,r.useEffect)(()=>{e.A(21933).then(e=>{let t=e.getSupabaseClient();l(t),(async()=>{try{let{data:e}=await t.auth.getUser();e&&e.user&&c(e.user)}catch(e){console.warn("[Share] supabase getUser failed",e)}})();let{data:r}=t.auth.onAuthStateChange((e,r)=>{r&&r.access_token?t.auth.getUser().then(e=>{e?.data?.user&&c(e.data.user)}).catch(()=>{}):c(null)});return()=>{try{r?.subscription?.unsubscribe?.()}catch(e){}}}).catch(e=>console.warn("[Share] failed to init supabase",e))},[]);let w=async()=>{try{let e=new URLSearchParams(window.location.search).get("token");try{let t="https://approved-app-pietros-projects-7763063d.vercel.app".trim();if(t){let r=window.location.origin.replace(/\/+$/,""),a=t.replace(/\/+$/,"");if(a&&r!==a){let t=`/share/${encodeURIComponent(i||"")}`+(e?`?token=${encodeURIComponent(e)}`:""),r=`${a}${t}`;window.location.replace(r);return}}}catch(e){console.warn("[Share] redirect check failed",e)}if(!i||!e){m("Link non valido"),u(!1);return}let t=await fetch(`/api/share/details?share_id=${encodeURIComponent(i)}&token=${encodeURIComponent(e)}`);if(!t.ok){let e=await t.json().catch(()=>({}));console.error("[Share] details API failed",t.status,e),m(e?.error||"Link non trovato o non valido."),u(!1);return}let r=await t.json();p(r),u(!1)}catch(e){console.error("[Share] initialize error",e),m("Errore durante il caricamento del link."),u(!1)}},k=async()=>{let e=new URLSearchParams(window.location.search).get("token")||"";if(!s){try{localStorage.setItem("pending_share",JSON.stringify({share_id:i,token:e}))}catch(e){console.warn("[Share] could not set pending_share",e)}return f&&n?void await b(f):void o.push("/register")}try{let t=await fetch("/api/share/redeem",{method:"POST",headers:{"Content-Type":"application/json","x-actor-id":s.id},body:JSON.stringify({share_id:i,token:e})});if(!t.ok){let e=await t.json().catch(()=>({}));m(e?.error||"Impossibile aprire il progetto");return}let r=await t.json();if(y(!0),r&&r.project_id)try{localStorage.setItem("open_project",r.project_id)}catch(e){console.warn("[Share] Could not set open_project in localStorage",e)}setTimeout(()=>o.push("/"),400)}catch(e){console.error("[Share] redeem error",e),m("Errore durante l'apertura del progetto")}},b=async e=>{if(!n)return void m("Impossibile inizializzare l'autenticazione");v(!0);try{let t=window.location.href.split("#")[0],r=await n.auth.signInWithOtp({email:e,options:{emailRedirectTo:t}});r.error?m(r.error.message||"Errore durante l'invio del link"):y(!0)}catch(e){console.error("[Share] sendMagicLink error",e),m(e?.message||"Errore durante l'invio del link")}finally{v(!1)}};return((0,r.useEffect)(()=>{if(s&&!h&&d&&!x){let e=setTimeout(()=>{k()},200);return()=>clearTimeout(e)}},[s,h,d,x]),h)?(0,t.jsx)("div",{style:{padding:40},children:"Caricamento link…"}):g?(0,t.jsxs)("div",{style:{padding:40},children:[(0,t.jsx)("h2",{children:"Link non valido"}),(0,t.jsx)("p",{children:g}),(0,t.jsx)("button",{onClick:()=>o.push("/"),children:"Torna alla home"})]}):x?(0,t.jsx)("div",{style:{padding:40},children:(0,t.jsx)("h2",{children:"Aprendo il progetto…"})}):(0,t.jsxs)("div",{style:{padding:24,maxWidth:680,margin:"40px auto"},children:[(0,t.jsx)("h2",{children:"Progetto condiviso"}),(0,t.jsxs)("p",{style:{color:"#999"},children:["Progetto: ",(0,t.jsx)("strong",{children:d.project_name})]}),(0,t.jsxs)("p",{style:{color:"#999"},children:["Ruolo consentito: ",(0,t.jsx)("strong",{children:d.role})]}),(0,t.jsx)("div",{style:{marginTop:20},children:s?(0,t.jsx)("button",{onClick:k,style:{padding:"10px 14px"},children:"Apri progetto"}):(0,t.jsxs)("div",{style:{display:"flex",gap:8,flexDirection:"column",maxWidth:420},children:[(0,t.jsx)("p",{style:{color:"#555"},children:"Per aprire il progetto devi avere un account. Puoi crearne uno rapidamente inserendo la tua email qui sotto; ti invieremo un link magico per accedere e completare l'apertura."}),(0,t.jsx)("input",{type:"email",value:f,onChange:e=>j(e.target.value),placeholder:"La tua email",style:{padding:"8px 10px",fontSize:16}}),(0,t.jsxs)("div",{style:{display:"flex",gap:8},children:[(0,t.jsx)("button",{onClick:()=>b(f),disabled:S||!f,style:{padding:"10px 14px"},children:S?"Invio…":"Ricevi link magico"}),(0,t.jsx)("button",{onClick:()=>{localStorage.setItem("pending_share",JSON.stringify({share_id:i,token:new URLSearchParams(window.location.search).get("token")||""})),o.push("/login")},style:{padding:"10px 14px"},children:"Ho già un account (Accedi)"})]})]})})]})}e.s(["default",()=>o])},21933,e=>{e.v(e=>Promise.resolve().then(()=>e(53210)))}]);