(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,18566,(e,t,r)=>{t.exports=e.r(76562)},33174,e=>{"use strict";var t=e.i(43476),r=e.i(71645),o=e.i(18566);function a(){let a=(0,o.useRouter)(),n=(0,o.useParams)().token,[i,s]=(0,r.useState)(null),[l,c]=(0,r.useState)(null),[d,h]=(0,r.useState)(null),[p,u]=(0,r.useState)(!0),[g,j]=(0,r.useState)(""),[m,f]=(0,r.useState)(!1);(0,r.useEffect)(()=>{S()},[n]),(0,r.useEffect)(()=>{e.A(21933).then(e=>{let t=e.getSupabaseClient();s(t),(async()=>{try{let{data:e}=await t.auth.getUser();e&&e.user&&c(e.user)}catch(e){console.warn("[Share] supabase getUser failed",e)}})();let{data:r}=t.auth.onAuthStateChange((e,r)=>{r&&r.access_token?t.auth.getUser().then(e=>{e?.data?.user&&c(e.data.user)}).catch(()=>{}):c(null)});return()=>{try{r?.subscription?.unsubscribe?.()}catch(e){}}}).catch(e=>console.warn("[Share] failed to init supabase",e))},[]);let S=async()=>{try{let e=new URLSearchParams(window.location.search).get("token");try{let t="https://approved-app-pietros-projects-7763063d.vercel.app".trim();if(t){let r=window.location.origin.replace(/\/+$/,""),o=t.replace(/\/+$/,"");if(o&&r!==o){let t=`/share/${encodeURIComponent(n||"")}`+(e?`?token=${encodeURIComponent(e)}`:""),r=`${o}${t}`;window.location.replace(r);return}}}catch(e){console.warn("[Share] redirect check failed",e)}if(!n||!e){j("Link non valido"),u(!1);return}let t=await fetch(`/api/share/details?share_id=${encodeURIComponent(n)}&token=${encodeURIComponent(e)}`);if(!t.ok){let e=await t.json().catch(()=>({}));console.error("[Share] details API failed",t.status,e),j(e?.error||"Link non trovato o non valido."),u(!1);return}let r=await t.json();h(r),u(!1)}catch(e){console.error("[Share] initialize error",e),j("Errore durante il caricamento del link."),u(!1)}},y=async()=>{let e=new URLSearchParams(window.location.search).get("token")||"";if(!l){localStorage.setItem("pending_share",JSON.stringify({share_id:n,token:e})),a.push("/login");return}try{let t=await fetch("/api/share/redeem",{method:"POST",headers:{"Content-Type":"application/json","x-actor-id":l.id},body:JSON.stringify({share_id:n,token:e})});if(!t.ok){let e=await t.json().catch(()=>({}));j(e?.error||"Impossibile aprire il progetto");return}let r=await t.json();if(f(!0),r&&r.project_id)try{localStorage.setItem("open_project",r.project_id)}catch(e){console.warn("[Share] Could not set open_project in localStorage",e)}setTimeout(()=>a.push("/"),400)}catch(e){console.error("[Share] redeem error",e),j("Errore durante l'apertura del progetto")}};return((0,r.useEffect)(()=>{if(l&&!p&&d&&!m){let e=setTimeout(()=>{y()},200);return()=>clearTimeout(e)}},[l,p,d,m]),p)?(0,t.jsx)("div",{style:{padding:40},children:"Caricamento link…"}):g?(0,t.jsxs)("div",{style:{padding:40},children:[(0,t.jsx)("h2",{children:"Link non valido"}),(0,t.jsx)("p",{children:g}),(0,t.jsx)("button",{onClick:()=>a.push("/"),children:"Torna alla home"})]}):m?(0,t.jsx)("div",{style:{padding:40},children:(0,t.jsx)("h2",{children:"Aprendo il progetto…"})}):(0,t.jsxs)("div",{style:{padding:24,maxWidth:680,margin:"40px auto"},children:[(0,t.jsx)("h2",{children:"Progetto condiviso"}),(0,t.jsxs)("p",{style:{color:"#999"},children:["Progetto: ",(0,t.jsx)("strong",{children:d.project_name})]}),(0,t.jsxs)("p",{style:{color:"#999"},children:["Ruolo consentito: ",(0,t.jsx)("strong",{children:d.role})]}),(0,t.jsx)("div",{style:{marginTop:20},children:(0,t.jsx)("button",{onClick:y,style:{padding:"10px 14px"},children:l?"Apri progetto":"Accedi per aprire"})})]})}e.s(["default",()=>a])},21933,e=>{e.v(t=>Promise.all(["static/chunks/5e12cd52e6f0e646.js"].map(t=>e.l(t))).then(()=>t(53210)))}]);